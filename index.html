<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediConnect - Your Health, Your Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* --- General & Landing Page Styles --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Consistent light gray background */
        }
        .hero-gradient {
            background: linear-gradient(135deg, rgba(240, 249, 255, 0.95) 0%, rgba(243, 232, 255, 0.95) 100%);
        }
        .hero-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('https://i.ibb.co/YFBv8wWz/gettyimages-1365582872-612x612.jpg') no-repeat center center;
            background-size: cover;
            filter: blur(8px) saturate(1.2);
            z-index: -1;
        }
        .modal-scrollbar::-webkit-scrollbar { width: 8px; }
        .modal-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .modal-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .modal-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Dashboard Modal Animation --- */
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.3s ease-in forwards; }
        .modal-content-enter { animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .modal-content-leave { animation: scaleOut 0.3s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes scaleOut { from { transform: scale(1); opacity: 1; } to { transform: scale(0.9); opacity: 0; } }

        /* --- Doctor Dashboard Custom Scrollbar --- */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* --- AI Chatbot Styles --- */
        .chatbot-modal-enter { animation: slideInUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .chatbot-modal-leave { animation: slideOutDown 0.3s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards; }
        .message-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideOutDown { from { transform: translateY(0); opacity: 1; } to { transform: translateY(100%); opacity: 0; } }
        
        /* Additional Custom Styling for improved UI/UX */
        .btn-primary { @apply rounded-lg bg-blue-600 hover:bg-blue-700 transition-all shadow-lg hover:shadow-xl text-white font-semibold; }
        .btn-secondary { @apply rounded-lg border bg-white/70 backdrop-blur-sm hover:bg-slate-50 transition-all text-slate-700 font-semibold; }
        .card { @apply bg-white p-6 rounded-2xl shadow-md border border-slate-100; }
        .input-field { @apply mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500; }
        .sub-heading { @apply text-md font-semibold text-slate-800 border-b pb-2 mb-4; }
        .badge { @apply px-2.5 py-1 text-xs font-semibold rounded-full; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased">

    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 id="confirmation-title" class="text-lg font-semibold mb-2">Are you sure?</h3>
            <p id="confirmation-message" class="text-sm text-slate-600 mb-6">Do you really want to log out? Any unsaved changes will be lost.</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-confirmation" class="px-4 py-2 text-sm font-medium text-slate-600 bg-white border rounded-lg hover:bg-slate-100">Cancel</button>
                <button id="confirm-action" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">Log Out</button>
            </div>
        </div>
    </div>

    <div id="loading-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[70] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
            <p class="mt-4 text-slate-700 font-medium">Please wait...</p>
        </div>
    </div>

    <div id="landing-page-view">
        <header class="bg-white/80 backdrop-blur-md sticky top-0 z-40 border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <div class="flex-shrink-0">
                        <a href="#" class="flex items-center gap-3">
                            <img class="h-12 w-12 object-contain" src="https://i.ibb.co/Q7RdwY9H/Picsart-25-09-11-20-47-42-475.png" alt="MediConnect Logo">
                            <span class="text-2xl font-bold text-slate-900">MediConnect</span>
                        </a>
                    </div>
                    <nav class="hidden md:flex md:items-center md:space-x-8">
                        <a href="#features" class="font-medium text-slate-600 hover:text-blue-600 transition-colors">Features</a>
                        <a href="#how-it-works" class="font-medium text-slate-600 hover:text-blue-600 transition-colors">How It Works</a>
                        <a href="#about" class="font-medium text-slate-600 hover:text-blue-600 transition-colors">About</a>
                    </nav>
                    <div class="hidden md:flex items-center">
                        <button id="open-auth-modal-header" class="rounded-lg bg-blue-600 hover:bg-blue-700 transition-all shadow hover:shadow-lg px-5 py-2.5 text-white font-semibold">
                            Sign In / Sign Up
                        </button>
                    </div>
                    <div class="md:hidden">
                        <button id="mobile-menu-button" class="inline-flex items-center justify-center p-2 rounded-md text-slate-500 hover:text-slate-700 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                            <span class="sr-only">Open main menu</span>
                            <i data-lucide="menu"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div id="mobile-menu" class="md:hidden hidden">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <a href="#features" class="block px-3 py-2 rounded-md text-base font-medium text-slate-600 hover:bg-slate-50 hover:text-blue-600">Features</a>
                    <a href="#how-it-works" class="block px-3 py-2 rounded-md text-base font-medium text-slate-600 hover:bg-slate-50 hover:text-blue-600">How It Works</a>
                    <a href="#about" class="block px-3 py-2 rounded-md text-base font-medium text-slate-600 hover:bg-slate-50 hover:text-blue-600">About</a>
                    <button class="auth-trigger block w-full text-left mt-2 px-4 py-3 rounded-lg bg-blue-600 text-white font-semibold">Sign In / Sign Up</button>
                </div>
            </div>
        </header>

        <main>
            <section class="relative hero-gradient py-20 md:py-32 overflow-hidden">
                <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center z-10">
                    <h1 class="text-4xl md:text-6xl font-extrabold text-slate-900 leading-tight tracking-tight">
                        Your Health. Your Control. <span class="text-blue-600">Your Future.</span>
                    </h1>
                    <p class="mt-6 max-w-2xl mx-auto text-lg text-slate-700 font-medium">
                        MediConnect unifies your medical records on a secure, decentralized platform. Grant access on your terms and leverage AI for powerful, private health insights.
                    </p>
                    <div class="mt-10 flex flex-col sm:flex-row items-center justify-center gap-4">
                        <button class="auth-trigger w-full sm:w-auto rounded-lg bg-blue-600 hover:bg-blue-700 transition-all shadow-lg hover:shadow-xl px-8 py-4 text-lg text-white font-semibold">
                            Get Started
                        </button>
                        <a href="#features" class="w-full sm:w-auto rounded-lg border bg-white/70 backdrop-blur-sm hover:bg-slate-50 transition-all px-8 py-4 text-lg text-slate-700 font-semibold">
                            Learn More
                        </a>
                    </div>
                </div>
            </section>
            <section id="features" class="py-20 md:py-28 bg-white">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold tracking-tight text-slate-900 sm:text-4xl">A New Era of Healthcare Management</h2>
                        <p class="mt-4 text-lg text-slate-600 max-w-2xl mx-auto">
                            Our platform is built on cutting-edge technology to ensure your data is secure, accessible, and insightful.
                        </p>
                    </div>
                    <div class="mt-16 grid gap-8 md:grid-cols-2 lg:grid-cols-4">
                        <div class="p-8 bg-slate-50 rounded-2xl border border-slate-200/80">
                            <div class="bg-blue-100 text-blue-600 rounded-full h-12 w-12 flex items-center justify-center">
                                <i data-lucide="user-check" class="h-6 w-6"></i>
                            </div>
                            <h3 class="mt-6 text-xl font-bold text-slate-900">Total Data Ownership</h3>
                            <p class="mt-2 text-slate-600">You are the sole controller of your health records. Grant and revoke access to doctors, hospitals, and researchers anytime.</p>
                        </div>
                        <div class="p-8 bg-slate-50 rounded-2xl border border-slate-200/80">
                            <div class="bg-violet-100 text-violet-600 rounded-full h-12 w-12 flex items-center justify-center">
                                <i data-lucide="shield-check" class="h-6 w-6"></i>
                            </div>
                            <h3 class="mt-6 text-xl font-bold text-slate-900">Blockchain Security</h3>
                            <p class="mt-2 text-slate-600">Leveraging blockchain for an immutable, transparent, and tamper-proof log of all data access and activity.</p>
                        </div>
                        <div class="p-8 bg-slate-50 rounded-2xl border border-slate-200/80">
                            <div class="bg-emerald-100 text-emerald-600 rounded-full h-12 w-12 flex items-center justify-center">
                                <i data-lucide="brain-circuit" class="h-6 w-6"></i>
                            </div>
                            <h3 class="mt-6 text-xl font-bold text-slate-900">AI-Powered Insights</h3>
                            <p class="mt-2 text-slate-600">Our explainable AI analyzes your anonymized data to provide early detection and personalized health recommendations.</p>
                        </div>
                        <div class="p-8 bg-slate-50 rounded-2xl border border-slate-200/80">
                            <div class="bg-rose-100 text-rose-600 rounded-full h-12 w-12 flex items-center justify-center">
                                <i data-lucide="link" class="h-6 w-6"></i>
                            </div>
                            <h3 class="mt-6 text-xl font-bold text-slate-900">Seamless Interoperability</h3>
                            <p class="mt-2 text-slate-600">Connect records from diverse healthcare systems and formats into one unified, comprehensive health profile.</p>
                        </div>
                    </div>
                </div>
            </section>
            <section id="how-it-works" class="py-20 md:py-28 bg-slate-50">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold tracking-tight text-slate-900 sm:text-4xl">Simple Steps to Empower Your Health</h2>
                        <p class="mt-4 text-lg text-slate-600 max-w-2xl mx-auto">
                            Getting started with MediConnect is easy and intuitive.
                        </p>
                    </div>
                    <div class="mt-16 relative">
                        <div class="relative grid gap-12 lg:grid-cols-3">
                            <div class="text-center">
                                <div class="relative flex items-center justify-center">
                                    <div class="w-20 h-20 flex items-center justify-center rounded-full bg-white border-2 border-slate-300 text-blue-600 text-2xl font-bold z-10">1</div>
                                </div>
                                <h3 class="mt-6 text-xl font-bold text-slate-900">Aggregate Your Data</h3>
                                <p class="mt-2 text-slate-600">Securely link all your medical records from different providers into a single, unified view.</p>
                            </div>
                            <div class="text-center">
                                <div class="relative flex items-center justify-center">
                                    <div class="w-20 h-20 flex items-center justify-center rounded-full bg-white border-2 border-slate-300 text-blue-600 text-2xl font-bold z-10">2</div>
                                </div>
                                <h3 class="mt-6 text-xl font-bold text-slate-900">Manage Consent</h3>
                                <p class="mt-2 text-slate-600">Use our intuitive dashboard to grant or revoke data access to healthcare professionals and researchers with a single click.</p>
                            </div>
                            <div class="text-center">
                                <div class="relative flex items-center justify-center">
                                    <div class="w-20 h-20 flex items-center justify-center rounded-full bg-white border-2 border-slate-300 text-blue-600 text-2xl font-bold z-10">3</div>
                                </div>
                                <h3 class="mt-6 text-xl font-bold text-slate-900">Unlock Insights</h3>
                                <p class="mt-2 text-slate-600">Leverage AI analysis to understand your health better, identify potential risks, and receive personalized recommendations.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="about" class="py-20 md:py-28 bg-white">
                <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="grid md:grid-cols-2 gap-12 items-center">
                        <div class="flex justify-center items-center">
                            <img class="bg-slate-50 p-8 rounded-2xl shadow-xl object-contain w-1/2" src="https://i.ibb.co/Q7RdwY9H/Picsart-25-09-11-20-47-42-475.png" alt="MediConnect Logo">
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold tracking-tight text-slate-900 sm:text-4xl">Our Mission</h2>
                            <p class="mt-4 text-slate-600">
                                We believe that healthcare data should be secure, transparent, and controlled by the patient. Our mission is to break down data silos and empower individuals with the tools and insights they need to manage their health proactively. By integrating blockchain and AI, we are building a more trustworthy and efficient healthcare ecosystem for everyone.
                            </p>
                        </div>
                    </div>
                </div>
            </section>
            <section class="bg-blue-600">
                <div class="max-w-7xl mx-auto py-16 px-4 sm:px-6 lg:px-8 text-center">
                    <h2 class="text-3xl font-extrabold text-white sm:text-4xl">
                        Ready to Take Control of Your Health Data?
                    </h2>
                    <p class="mt-4 text-lg text-blue-100">
                        Join MediConnect today and be part of the future of healthcare.
                    </p>
                    <button class="auth-trigger mt-8 inline-block w-full sm:w-auto rounded-lg bg-white hover:bg-slate-100 transition-all shadow-lg hover:shadow-xl px-8 py-4 text-lg text-blue-600 font-semibold">
                        Get Started for Free
                    </button>
                </div>
            </section>
        </main>

        <footer class="bg-slate-900 text-slate-400">
            <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
                <div class="md:flex md:items-center md:justify-between">
                    <div class="flex justify-center md:order-1">
                        <a href="#" class="flex items-center gap-3">
                            <img class="h-10 w-10 object-contain" src="https://i.ibb.co/Q7RdwY9H/Picsart-25-09-11-20-47-42-475.png" alt="MediConnect Logo">
                            <span class="text-xl font-bold text-white">MediConnect</span>
                        </a>
                    </div>
                    <div class="mt-8 md:mt-0 md:order-2 flex justify-center space-x-6">
                        <a href="https://x.com/Medi__connect" target="_blank" rel="noopener noreferrer" class="hover:text-white"><span class="sr-only">Twitter</span><i data-lucide="twitter"></i></a>
                        <a href="http://www.linkedin.com/in/medi-connect-239067384" target="_blank" rel="noopener noreferrer" class="hover:text-white"><span class="sr-only">LinkedIn</span><i data-lucide="linkedin"></i></a>
                        <a href="https://github.com/ADHARV-S-RAVI" target="_blank" rel="noopener noreferrer" class="hover:text-white"><span class="sr-only">GitHub</span><i data-lucide="github"></i></a>
                    </div>
                    <div class="mt-8 md:mt-0 md:order-1">
                        <p class="text-center text-base">
                            &copy; 2025 MediConnect. All rights reserved.
                        </p>
                    </div>
                </div>
            </div>
        </footer>

        <div id="auth-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
            <div id="modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col transition-all duration-300 transform scale-95 opacity-0">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 id="modal-title" class="text-lg font-semibold">Welcome to MediConnect</h3>
                    <button id="close-modal-button" class="text-slate-400 hover:text-slate-600">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
                <div class="flex-grow overflow-y-auto modal-scrollbar">
                    <div id="initial-view" class="p-6 space-y-4">
                        <button id="google-sign-in-btn" class="w-full flex items-center justify-center gap-3 py-3 px-4 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors">
                            <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19-5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                            <span>Sign in with Google</span>
                        </button>
                        <div class="relative flex py-2 items-center">
                            <div class="flex-grow border-t border-slate-200"></div>
                            <span class="flex-shrink mx-4 text-slate-400 text-sm">OR</span>
                            <div class="flex-grow border-t border-slate-200"></div>
                        </div>
                        <form id="login-form" class="space-y-4">
                            <div>
                                <label for="email" class="text-sm font-medium text-slate-700">Email</label>
                                <input type="email" id="email" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="you@example.com" required>
                            </div>
                            <div>
                                <label for="password" class="text-sm font-medium text-slate-700">Password</label>
                                <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Sign In</button>
                        </form>
                        <p class="text-center text-sm">Don't have an account? <button id="go-to-role-select" class="font-medium text-blue-600 hover:underline">Sign Up</button></p>
                    </div>
                    <div id="role-select-view" class="hidden p-6 text-center">
                        <p class="mb-6">First, let's get to know you. Are you a...</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button id="select-patient-role" class="flex flex-col items-center justify-center p-6 border-2 border-slate-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-all">
                                <i data-lucide="user" class="h-10 w-10 text-blue-600 mb-2"></i>
                                <span class="font-semibold">Patient</span>
                                <span class="text-xs text-slate-500 mt-1">I want to manage my health records.</span>
                            </button>
                            <button id="select-doctor-role" class="flex flex-col items-center justify-center p-6 border-2 border-slate-200 rounded-lg hover:border-violet-500 hover:bg-violet-50 transition-all">
                                <i data-lucide="stethoscope" class="h-10 w-10 text-violet-600 mb-2"></i>
                                <span class="font-semibold">Doctor</span>
                                <span class="text-xs text-slate-500 mt-1">I am a healthcare professional.</span>
                            </button>
                        </div>
                        <button class="back-to-login text-sm text-slate-500 hover:underline mt-6"> &larr; Back to login</button>
                    </div>
                    <div id="patient-form-view" class="hidden p-6 space-y-4">
                        <form id="patient-form">
                            <div>
                                <label for="patient-signup-email" class="text-sm font-medium text-slate-700">Email</label>
                                <input type="email" id="patient-signup-email" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="you@example.com" required>
                            </div>
                            <div>
                                <label for="patient-signup-password" class="text-sm font-medium text-slate-700">Password</label>
                                <input type="password" id="patient-signup-password" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <h4 class="text-md font-semibold text-slate-800 border-b pb-2 mb-4">Personal Details</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="patient-name-input" class="text-sm font-medium">Full Name</label>
                                    <input type="text" id="patient-name-input" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm" required>
                                </div>
                                <div>
                                    <label for="patient-dob-input" class="text-sm font-medium">Date of Birth</label>
                                    <input type="date" id="patient-dob-input" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm" required>
                                </div>
                                <div>
                                    <label for="patient-gender-select" class="text-sm font-medium">Gender</label>
                                    <select id="patient-gender-select" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm">
                                        <option>Select...</option><option>Male</option><option>Female</option><option>Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="patient-contact-input" class="text-sm font-medium">Contact Number</label>
                                    <input type="tel" id="patient-contact-input" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm" required>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="patient-emergency-contact-input" class="text-sm font-medium">Emergency Contact</label>
                                    <input type="tel" id="patient-emergency-contact-input" placeholder="Name & Phone Number" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm" required>
                                </div>
                            </div>
                            <h4 class="text-md font-semibold text-slate-800 border-b pb-2 my-6">Medical Details</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="patient-blood-group-input" class="text-sm font-medium">Blood Group</label>
                                    <input type="text" id="patient-blood-group-input" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm">
                                </div>
                                <div>
                                    <label for="patient-allergies-input" class="text-sm font-medium">Allergies</label>
                                    <input type="text" id="patient-allergies-input" placeholder="e.g., Peanuts, Penicillin" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm">
                                </div>
                                <div class="md:col-span-2">
                                    <label for="patient-medications-textarea" class="text-sm font-medium">Current Medications</label>
                                    <textarea id="patient-medications-textarea" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm" rows="2"></textarea>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="patient-history-textarea" class="text-sm font-medium">Past Medical History</label>
                                    <textarea id="patient-history-textarea" placeholder="e.g., Asthma, Surgery in 2020" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm" rows="2"></textarea>
                                </div>
                            </div>
                            <h4 class="text-md font-semibold text-slate-800 border-b pb-2 my-6">Medical Records</h4>
                            <div>
                                <label class="text-sm font-medium">Upload Past Records</label>
                                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md">
                                    <div class="space-y-1 text-center">
                                        <i data-lucide="upload-cloud" class="mx-auto h-12 w-12 text-slate-400"></i>
                                        <div class="flex text-sm text-slate-600">
                                            <label for="patient-file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                                                <span>Upload a file</span>
                                                <input id="patient-file-upload" name="patient-file-upload" type="file" class="sr-only">
                                            </label>
                                            <p class="pl-1">or drag and drop</p>
                                        </div>
                                        <p class="text-xs text-slate-500">PDF, PNG, JPG up to 10MB</p>
                                    </div>
                                </div>
                            </div>
                            <h4 class="text-md font-semibold text-slate-800 border-b pb-2 my-6">Consent Management</h4>
                            <div class="space-y-3">
                                <label class="flex items-start p-3 bg-slate-50 rounded-lg">
                                    <input type="checkbox" id="consent-doctors" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mt-1">
                                    <span class="ml-3 text-sm">
                                        <span class="font-medium text-slate-800">Allow affiliated doctors to view my records</span>
                                        <p class="text-slate-500">This enables faster diagnosis and consultation within the MediConnect network.</p>
                                    </span>
                                </label>
                                <label class="flex items-start p-3 bg-slate-50 rounded-lg">
                                    <input type="checkbox" id="consent-research" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 mt-1">
                                    <span class="ml-3 text-sm">
                                        <span class="font-medium text-slate-800">Contribute my anonymized data for research</span>
                                        <p class="text-slate-500">Help advance medical science. Your identity will always remain private.</p>
                                    </span>
                                </label>
                            </div>
                            <div class="mt-8 flex justify-between items-center">
                                <button type="button" class="back-to-roles text-sm text-slate-500 hover:underline">&larr; Back</button>
                                <button type="submit" class="bg-blue-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Create Account</button>
                            </div>
                        </form>
                    </div>
                    <div id="doctor-form-view" class="hidden p-6 space-y-4">
                        <form id="doctor-form">
                            <div>
                                <label for="doctor-signup-email" class="text-sm font-medium text-slate-700">Email</label>
                                <input type="email" id="doctor-signup-email" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div>
                                <label for="doctor-signup-password" class="text-sm font-medium text-slate-700">Password</label>
                                <input type="password" id="doctor-signup-password" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <h4 class="text-md font-semibold text-slate-800 border-b pb-2 mb-4">Professional Details</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="doctor-name-input" class="text-sm font-medium">Full Name</label>
                                    <input type="text" id="doctor-name-input" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm" required>
                                </div>
                                <div>
                                    <label for="doctor-specialization-input" class="text-sm font-medium">Specialization</label>
                                    <input type="text" id="doctor-specialization-input" placeholder="e.g., Cardiology" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm" required>
                                </div>
                                <div>
                                    <label for="doctor-experience-input" class="text-sm font-medium">Years of Experience</label>
                                    <input type="number" id="doctor-experience-input" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm" required>
                                </div>
                                <div>
                                    <label for="doctor-license-input" class="text-sm font-medium">Medical License Number</label>
                                    <input type="text" id="doctor-license-input" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm" required>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="doctor-hospital-input" class="text-sm font-medium">Hospital Affiliation</label>
                                    <input type="text" id="doctor-hospital-input" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm" required>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="doctor-contact-email-input" class="text-sm font-medium">Contact Email</label>
                                    <input type="email" id="doctor-contact-email-input" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm" required>
                                </div>
                            </div>
                            <h4 class="text-md font-semibold text-slate-800 border-b pb-2 my-6">Verification</h4>
                            <div>
                                <label class="text-sm font-medium">Upload License / ID Proof</label>
                                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md">
                                    <div class="space-y-1 text-center">
                                        <i data-lucide="file-check-2" class="mx-auto h-12 w-12 text-slate-400"></i>
                                        <div class="flex text-sm text-slate-600">
                                            <label for="doctor-file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                                                <span>Upload document</span>
                                                <input id="doctor-file-upload" name="doctor-file-upload" type="file" class="sr-only">
                                            </label>
                                        </div>
                                        <p class="text-xs text-slate-500">PDF, PNG, JPG up to 5MB</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8 flex justify-between items-center">
                                <button type="button" class="back-to-roles text-sm text-slate-500 hover:underline">&larr; Back</button>
                                <button type="submit" class="bg-violet-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-violet-700 transition-colors">Submit for Verification</button>
                            </div>
                        </form>
                    </div>
                    <div id="success-view" class="hidden p-10 text-center flex flex-col items-center justify-center">
                        <div class="w-20 h-20 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center">
                            <i data-lucide="check" class="w-12 h-12"></i>
                        </div>
                        <h3 class="text-xl font-bold mt-6">Registration Successful!</h3>
                        <p class="text-slate-500 mt-2">Welcome to MediConnect. You can now proceed to your dashboard.</p>
                        <button id="go-to-dashboard-btn" class="mt-6 w-full bg-blue-600 text-white py-2.5 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Go to Dashboard</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="patient-dashboard-view" class="hidden bg-slate-50">
        <div id="patient-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 class="text-lg font-semibold">Settings</h3>
                    <button id="close-patient-settings-modal" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="h-6 w-6"></i></button>
                </div>
                <div class="flex-grow overflow-y-auto p-6 space-y-4">
                    <p class="text-sm text-slate-500">Account settings and preferences can be configured here.</p>
                </div>
            </div>
        </div>
        <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 items-center justify-center p-4">
            <div id="profile-modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 class="text-lg font-semibold">Edit Patient Details</h3>
                    <button id="close-profile-modal" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="h-6 w-6"></i></button>
                </div>
                <div class="flex-grow overflow-y-auto p-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-medium text-slate-700">Full Name</label>
                            <input type="text" id="profile-name" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm" />
                        </div>
                        <div>
                            <label class="text-sm font-medium text-slate-700">Date of Birth</label>
                            <input type="date" id="profile-dob" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm" />
                        </div>
                        <div>
                            <label class="text-sm font-medium text-slate-700">Gender</label>
                            <select id="profile-gender" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm">
                                <option>Female</option><option>Male</option><option>Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-slate-700">Contact Number</label>
                            <input type="tel" id="profile-contact" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm" />
                        </div>
                        <div class="md:col-span-2">
                            <label class="text-sm font-medium text-slate-700">Emergency Contact</label>
                            <input type="text" id="profile-emergency" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm" />
                        </div>
                    </div>
                </div>
                <div class="flex justify-end p-4 border-t bg-slate-50 rounded-b-2xl">
                    <button id="cancel-profile-save" class="px-4 py-2 text-sm font-medium text-slate-600 bg-white border rounded-md hover:bg-slate-100 mr-2">Cancel</button>
                    <button id="save-profile" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Save Changes</button>
                </div>
            </div>
        </div>

        <div id="upload-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 items-center justify-center p-4">
            <div id="upload-modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 class="text-lg font-semibold">Upload New Medical Report</h3>
                    <button id="close-upload-modal" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="h-6 w-6"></i></button>
                </div>
                <div class="flex-grow overflow-y-auto p-6 space-y-4">
                    <div>
                        <label for="report-title" class="text-sm font-medium text-slate-700">Report Title</label>
                        <input type="text" id="report-title" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Annual Check-up Results">
                    </div>
                    <div>
                        <label for="report-description" class="text-sm font-medium text-slate-700">Description</label>
                        <textarea id="report-description" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="Briefly describe the report, e.g., Blood test from Dr. Smith on 2025-09-10."></textarea>
                    </div>
                    <div>
                        <label for="report-doctor-note" class="text-sm font-medium text-slate-700">Doctor's Note (Optional)</label>
                        <textarea id="report-doctor-note" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Follow up in 3 months. Patient advised to monitor blood pressure."></textarea>
                    </div>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md">
                        <div class="space-y-1 text-center">
                            <i data-lucide="upload-cloud" class="mx-auto h-12 w-12 text-slate-400"></i>
                            <div class="flex text-sm text-slate-600">
                                <label for="file-upload-patient" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                                    <span>Upload a file</span>
                                    <input id="file-upload-patient" name="patient-file-upload" type="file" class="sr-only">
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-slate-500">PDF, PNG, JPG up to 10MB</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end p-4 border-t bg-slate-50 rounded-b-2xl">
                    <button id="cancel-upload" class="px-4 py-2 text-sm font-medium text-slate-600 bg-white border rounded-md hover:bg-slate-100 mr-2">Cancel</button>
                    <button id="upload-report-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Upload Report</button>
                </div>
            </div>
        </div>

        <header class="flex items-center justify-between p-4 md:p-6 bg-white shadow-sm sticky top-0 z-10">
            <div class="flex items-center gap-3">
                <img src="https://i.ibb.co/Q7RdwY9H/Picsart-25-09-11-20-47-42-475.png" alt="MediConnect Logo" class="w-12 h-12 rounded-full object-cover">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">MediConnect</h1>
                    <p class="text-sm text-slate-500 hidden md:block">Patient-controlled health data with explainable AI.</p>
                </div>
            </div>
            <nav class="hidden md:flex gap-6 items-center text-sm">
                <button data-section="records" class="patient-nav-link hover:text-blue-600 transition-colors">Records</button>
                <button data-section="vitals" class="patient-nav-link hover:text-blue-600 transition-colors">Smart Records</button>
                <button data-section="ai" class="patient-nav-link hover:text-blue-600 transition-colors">AI Analysis</button>
                <button data-section="consent" class="patient-nav-link hover:text-blue-600 transition-colors">Consent</button>
                <button data-section="appointments-patient-section" class="patient-nav-link hover:text-blue-600 transition-colors">Appointments</button>
                <button data-section="logs" class="patient-nav-link hover:text-blue-600 transition-colors">Access Log</button>
                <button data-section="messages-patient-section" class="patient-nav-link hover:text-blue-600 transition-colors">Messages</button>
                <button data-section="settings-patient-section" class="patient-nav-link hover:text-blue-600 transition-colors">Settings</button>
                <button id="profile-button" class="ml-4 flex items-center gap-3 border-l pl-4 cursor-pointer hover:bg-slate-50 p-2 rounded-lg">
                    <div class="rounded-full w-10 h-10 bg-slate-200 flex items-center justify-center"><i data-lucide="user" class="text-slate-500 w-6 h-6"></i></div>
                    <div>
                        <div id="header-patient-name" class="font-semibold text-sm text-slate-700"></div>
                        <div id="header-patient-id" class="text-xs text-slate-500"></div>
                    </div>
                </button>
                <button id="logout-patient" class="ml-4 flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold text-red-600 border border-red-600 hover:bg-red-50 transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Log Out
                </button>
                </nav>
            <button class="md:hidden rounded-lg bg-blue-600 px-4 py-2 text-white">Menu</button>
        </header>

        <main class="p-4 md:p-6 max-w-6xl mx-auto">
            <section id="records" class="patient-main-section">
                <div class="rounded-2xl overflow-hidden grid md:grid-cols-2 gap-6 bg-gradient-to-br from-blue-50 to-violet-100 p-8 items-center border border-slate-200">
                    <div>
                        <h2 class="text-4xl font-bold text-slate-800 mb-4 leading-tight">Your Health. Your Control. Your Future.</h2>
                        <p class="text-slate-600 mb-6">Unify your medical records securely. Grant access on your terms and leverage AI for powerful, private health insights.</p>
                        <div class="flex flex-wrap gap-3">
                            <button id="explore-ai-btn" class="rounded-lg bg-violet-600 hover:bg-violet-700 transition-all shadow hover:shadow-lg px-5 py-2.5 text-white font-semibold">Explore AI Insights</button>
                            <button id="copy-hash-btn" class="rounded-lg border bg-white hover:bg-slate-50 transition-all px-5 py-2.5 text-slate-700">Copy Block Hash</button>
                        </div>
                        <div class="mt-8 text-sm text-slate-500 space-y-2">
                            <div class="flex items-center gap-2"><i data-lucide="database" class="w-4 h-4 text-violet-500"></i> Simulated storage: <span class="ml-1 font-medium text-slate-700">Federated + patient-owned</span></div>
                            <div class="flex items-center gap-2"><i data-lucide="lock" class="w-4 h-4 text-violet-500"></i> Privacy: <span class="ml-1 font-medium text-slate-700">Encryption & consent-first design</span></div>
                        </div>
                    </div>
                    <div class="bg-white/60 backdrop-blur-sm rounded-xl p-4 shadow-inner border border-slate-200/50">
                        <h3 class="text-lg font-semibold mb-3 text-slate-700">Health Snapshot</h3>
                        <ul id="health-snapshot-list" class="space-y-3 text-sm"></ul>
                        <div id="blockchain-anchor" class="mt-4 text-xs text-slate-500 truncate"></div>
                    </div>
                </div>
            </section>
            
            <section id="vitals" class="patient-main-section hidden mt-8">
                <div class="bg-white rounded-2xl p-6 shadow-md border border-slate-100">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Smart Health Records</h2>
                    <div id="vitals-filter-container" class="flex flex-wrap gap-2 border-b pb-4 mb-6"></div>
                    <div id="vitals-display-container" class="grid md:grid-cols-2 gap-6"></div>
                </div>
            </section>

            <section id="ai" class="patient-main-section hidden mt-8">
                <div class="bg-white rounded-2xl p-6 shadow-md border border-slate-100">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="bg-violet-100 p-2 rounded-full"><i data-lucide="brain" class="w-6 h-6 text-violet-500"></i></div>
                        <h3 class="text-xl font-semibold text-slate-800">AI-Powered Population Insights</h3>
                    </div>
                    <p class="text-sm text-slate-500 mb-4">Analyze anonymized data from thousands of patient records to identify trends, predict risks, and improve preventative care strategies. This is a powerful tool for researchers and clinicians.</p>
                    <button id="run-ai-btn" class="w-full rounded-lg bg-blue-600 hover:bg-blue-700 transition-all shadow hover:shadow-lg px-5 py-2.5 text-white font-semibold flex items-center justify-center gap-2"><i data-lucide="trending-up" class="w-5 h-5"></i>Analyze Population Data</button>
                    <div class="mt-4 p-4 bg-slate-50 rounded-lg border">
                        <h4 class="text-sm font-medium mb-2 text-slate-700">AI Report</h4>
                        <pre id="ai-report-content" class="text-xs whitespace-pre-wrap text-slate-700 min-h-[95px] font-mono leading-relaxed">Click button to run analysis.</pre>
                    </div>
                </div>
            </section>

            <section id="appointments-patient-section" class="patient-main-section hidden mt-8">
                <div class="bg-white rounded-2xl p-6 shadow-md border border-slate-100">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Appointments</h2>
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-xl font-semibold mb-3">Book an Appointment</h3>
                            <p class="text-sm text-slate-500 mb-4">Select a doctor to book a new consultation.</p>
                            <div id="doctor-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-3">My Appointments</h3>
                            <div id="my-appointments-list" class="space-y-4">
                                <div class="text-sm text-slate-500">You have no upcoming appointments.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="consent" class="patient-main-section hidden mt-8">
                <div class="bg-white rounded-2xl p-6 shadow-md border border-slate-100">
                    <h3 class="text-2xl font-bold mb-3 text-slate-800">Consent Manager</h3>
                    <p class="text-sm text-slate-500 mb-4">Toggle who can access your records. This simulates a dynamic, smart-contract permission flow on a blockchain.</p>
                    <div id="permissions-container" class="grid md:grid-cols-2 gap-4"></div>
                </div>
            </section>

            <section id="logs" class="patient-main-section hidden mt-8">
                <div class="bg-white rounded-2xl p-6 shadow-md border border-slate-100">
                    <h3 class="text-lg font-semibold mb-3 text-slate-800">Access Log (Append-Only)</h3>
                    <p class="text-sm text-slate-500 mb-4">Every permission change or data access attempt is recorded to build trust and transparency.</p>
                    <div id="access-log-container" class="space-y-2 max-h-56 overflow-auto text-xs bg-slate-50 p-3 rounded-lg border"></div>
                </div>
            </section>

            <section id="messages-patient-section" class="patient-main-section hidden mt-8">
                <div class="bg-white rounded-2xl p-6 shadow-md border border-slate-100">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold text-slate-800">Messages</h2>
                        <button id="compose-message-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700">Compose New</button>
                    </div>
                    <div id="patient-conversations-list" class="space-y-4">
                    </div>
                </div>
            </section>
            <section id="settings-patient-section" class="patient-main-section hidden mt-8">
                <div class="bg-white rounded-2xl p-6 shadow-md border border-slate-100">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Settings</h2>
                    <div id="patient-settings-content" class="text-sm text-slate-500">
                        <p>Manage your account preferences, notifications, and security settings here.</p>
                    </div>
                </div>
            </section>
            <footer class="mt-12 text-center text-xs text-slate-500 py-6 border-t">
                <div class="flex items-center justify-center gap-2"><i data-lucide="clock" class="w-4 h-4"></i> <span>MediConnect prototype — simulated demo only</span></div>
            </footer>
        </main>
        <button id="open-upload-modal-btn" class="fixed bottom-8 right-8 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-full p-4 shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
            <i data-lucide="file-plus-2" class="w-6 h-6"></i>
            <span class="hidden md:block">Upload New Report</span>
        </button>
    </div>


    <div id="doctor-dashboard-view" class="hidden">
        <div id="app" class="flex h-screen bg-slate-100">
            <aside class="w-64 bg-white border-r border-slate-200 flex flex-col flex-shrink-0">
                <div class="flex items-center justify-center h-20 border-b border-slate-200">
                    <a href="#" class="flex items-center gap-3">
                        <img class="h-12 w-12 object-contain" src="https://i.ibb.co/Q7RdwY9H/Picsart-25-09-11-20-47-42-475.png" alt="MediConnect Logo">
                        <span class="text-xl font-bold text-slate-900">MediConnect</span>
                    </a>
                </div>
                <nav class="flex-1 px-4 py-6 space-y-2">
                    <button class="nav-tab flex items-center gap-3 px-4 py-2.5 text-sm font-semibold bg-blue-50 text-blue-700 rounded-lg w-full" data-target="patient-search-view">
                        <i data-lucide="layout-dashboard"></i> Dashboard
                    </button>
                    <button class="nav-tab flex items-center gap-3 px-4 py-2.5 text-sm font-semibold text-slate-600 hover:bg-slate-100 rounded-lg w-full" data-target="appointments-doctor-section">
                        <i data-lucide="calendar-days"></i> Appointments
                    </button>
                    <button class="nav-tab flex items-center gap-3 px-4 py-2.5 text-sm font-semibold text-slate-600 hover:bg-slate-100 rounded-lg w-full" data-target="messages-doctor-section">
                        <i data-lucide="message-square"></i> Messages
                    </button>
                    <button class="nav-tab flex items-center gap-3 px-4 py-2.5 text-sm font-semibold text-slate-600 hover:bg-slate-100 rounded-lg w-full" data-target="settings-doctor-section">
                        <i data-lucide="settings"></i> Settings
                    </button>
                </nav>
                <div class="px-4 py-4 border-t border-slate-200">
                    <div class="flex items-center gap-3">
                        <img id="doctor-avatar" class="h-10 w-10 rounded-full object-cover" src="https://placehold.co/100x100/a7c5fd/333333?text=Dr.A" alt="Doctor Avatar">
                        <div>
                            <p id="doctor-sidebar-name" class="text-sm font-semibold text-slate-800">Dr. Alex Turner</p>
                            <p id="doctor-sidebar-id" class="text-xs text-slate-500">ID: DOC002</p>
                        </div>
                        <button id="logout-doctor" class="ml-auto text-slate-500 hover:text-red-500 transition-colors">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </aside>

            <main class="flex-1 flex flex-col h-screen overflow-y-auto custom-scrollbar">
                <header class="bg-white/80 backdrop-blur-md sticky top-0 z-30 h-20 flex items-center justify-between px-8 border-b border-slate-200">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">Doctor Dashboard</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="relative w-72">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                            <input type="text" id="patient-search-input" placeholder="Search Patient by ID or Name..." class="w-full pl-10 pr-4 py-2.5 bg-slate-100 border border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <button class="flex items-center justify-center w-10 h-10 bg-slate-100 rounded-lg text-slate-600 hover:bg-slate-200">
                            <i data-lucide="bell"></i>
                        </button>
                    </div>
                </header>

                <div id="dashboard-content" class="p-8">
                    <div id="patient-search-view" class="doctor-main-section">
                        <h2 class="text-xl font-semibold mb-4 text-slate-700">Patient Search Results</h2>
                        <div id="patient-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                        <div id="no-results" class="hidden text-center py-16">
                            <i data-lucide="user-search" class="mx-auto h-16 w-16 text-slate-400"></i>
                            <p class="mt-4 text-slate-500">Search for a patient to begin.</p>
                        </div>
                    </div>

                    <div id="appointments-doctor-section" class="doctor-main-section hidden">
                        <h2 class="text-xl font-semibold mb-4 text-slate-700">My Appointments</h2>
                        <div class="space-y-6">
                            <div>
                                <h3 class="text-lg font-semibold mb-3">Pending Requests</h3>
                                <div id="pending-appointments-list" class="space-y-4">
                                    <p class="text-sm text-slate-500">No new requests.</p>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold mb-3">Upcoming Appointments</h3>
                                <div id="accepted-appointments-list" class="space-y-4">
                                    <p class="text-sm text-slate-500">No upcoming appointments.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="messages-doctor-section" class="doctor-main-section hidden">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-slate-800">Messages</h2>
                        </div>
                        <div id="doctor-conversations-list" class="space-y-4">
                        </div>
                    </div>

                    <div id="settings-doctor-section" class="doctor-main-section hidden">
                        <h2 class="text-xl font-semibold mb-4 text-slate-700">Settings</h2>
                        <p class="text-sm text-slate-500">Manage your profile, availability, and preferences here.</p>
                    </div>

                    <div id="patient-profile-view" class="doctor-main-section hidden">
                        <div class="flex items-center justify-between mb-6">
                            <button id="back-to-search" class="flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-blue-600">
                                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                                Back to Search
                            </button>
                            <div class="flex gap-2">
                                <button class="dashboard-tab-button bg-white text-slate-700 shadow-sm border rounded-lg px-4 py-2 font-semibold text-sm hover:bg-slate-50" data-tab="profile">
                                    <i data-lucide="user-round" class="w-4 h-4 inline-block mr-2"></i>Patient Profile
                                </button>
                                <button class="dashboard-tab-button bg-white text-slate-700 shadow-sm border rounded-lg px-4 py-2 font-semibold text-sm hover:bg-slate-50" data-tab="consultation">
                                    <i data-lucide="file-plus-2" class="w-4 h-4 inline-block mr-2"></i>Add Consultation
                                </button>
                                <button id="message-patient-btn" class="bg-violet-600 text-white shadow-sm rounded-lg px-4 py-2 font-semibold text-sm hover:bg-violet-700">
                                    <i data-lucide="message-square" class="w-4 h-4 inline-block mr-2"></i>Message Patient
                                </button>
                                </div>
                        </div>

                        <div id="tab-content-wrapper">
                            <div id="profile-content" class="dashboard-tab-content">
                                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200/80 mb-6">
                                    <div class="flex flex-col md:flex-row items-start gap-6">
                                        <img id="patient-avatar" class="h-24 w-24 rounded-full object-cover border-4 border-slate-100" src="" alt="Patient Avatar">
                                        <div class="flex-1">
                                            <h2 id="patient-name" class="text-3xl font-bold text-slate-900"></h2>
                                            <p id="patient-meta" class="text-slate-500 mt-1"></p>
                                        </div>
                                        <div id="patient-contact-info" class="text-sm text-slate-600 space-y-1"></div>
                                    </div>
                                    <div class="mt-6 border-t pt-4">
                                        <h4 class="text-xs font-semibold uppercase text-slate-500 mb-3">AI Assistance</h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div class="bg-blue-50/50 p-4 rounded-lg border border-blue-200">
                                                <div class="flex items-center gap-2 text-blue-700 mb-1">
                                                    <i data-lucide="scan-text" class="w-5 h-5"></i>
                                                    <h5 class="font-semibold">Auto Summary</h5>
                                                </div>
                                                <p id="ai-summary" class="text-sm text-blue-900"></p>
                                            </div>
                                            <div class="bg-red-50/50 p-4 rounded-lg border border-red-200">
                                                <div class="flex items-center gap-2 text-red-700 mb-1">
                                                    <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                                                    <h5 class="font-semibold">Red Flag Alerts</h5>
                                                </div>
                                                <p id="red-flags" class="text-sm text-red-900"></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    <div class="lg:col-span-1 space-y-6">
                                        <div class="bg-white p-5 rounded-2xl shadow-sm border">
                                            <h3 class="font-semibold mb-3">Personal Information</h3>
                                            <div id="personal-info" class="text-sm space-y-2 text-slate-600"></div>
                                        </div>
                                        <div class="bg-white p-5 rounded-2xl shadow-sm border">
                                            <h3 class="font-semibold mb-3">Medical History</h3>
                                            <div id="medical-history" class="text-sm space-y-2 text-slate-600"></div>
                                        </div>
                                        <div class="bg-white p-5 rounded-2xl shadow-sm border">
                                            <h3 class="font-semibold mb-3">Lifestyle</h3>
                                            <div id="lifestyle-info" class="text-sm space-y-2 text-slate-600"></div>
                                        </div>
                                    </div>
                                    <div class="lg:col-span-2 bg-white p-5 rounded-2xl shadow-sm border">
                                        <h3 class="font-semibold mb-4">Medical Records Timeline</h3>
                                        <div id="records-timeline" class="relative border-l-2 border-slate-200 pl-6 space-y-8">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="consultation-content" class="dashboard-tab-content hidden">
                                <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-sm border">
                                    <div class="flex items-center gap-4 mb-6 border-b pb-4">
                                        <img id="consult-patient-avatar" class="h-12 w-12 rounded-full" src="" alt="Patient Avatar">
                                        <div>
                                            <h2 id="consult-patient-name" class="text-xl font-bold text-slate-800"></h2>
                                            <p id="consult-patient-id" class="text-sm text-slate-500"></p>
                                        </div>
                                    </div>
                                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Add New Consultation Note</h2>
                                    <form class="space-y-6">
                                        <div>
                                            <label for="symptoms" class="block text-sm font-medium text-slate-700 mb-1">Symptoms</label>
                                            <textarea id="symptoms" rows="3" class="w-full p-2 bg-slate-50 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                        </div>
                                        <div>
                                            <label for="diagnosis" class="block text-sm font-medium text-slate-700 mb-1">Diagnosis</label>
                                            <textarea id="diagnosis" rows="3" class="w-full p-2 bg-slate-50 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                        </div>
                                        <div>
                                            <label for="prescription" class="block text-sm font-medium text-slate-700 mb-1">Prescription</label>
                                            <textarea id="prescription" rows="4" class="w-full p-2 bg-slate-50 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Paracetamol 500mg - 1 tablet, 3 times a day for 3 days"></textarea>
                                        </div>
                                        <div>
                                            <label for="notes" class="block text-sm font-medium text-slate-700 mb-1">Additional Notes</label>
                                            <textarea id="notes" rows="2" class="w-full p-2 bg-slate-50 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                        </div>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <div>
                                                <label for="follow-up" class="block text-sm font-medium text-slate-700 mb-1">Follow-up Date</label>
                                                <input type="date" id="follow-up" class="w-full p-2 bg-slate-50 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-slate-700 mb-1">Upload Documents</label>
                                                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md">
                                                    <div class="space-y-1 text-center">
                                                        <i data-lucide="upload-cloud" class="mx-auto h-10 w-10 text-slate-400"></i>
                                                        <div class="flex text-sm text-slate-600">
                                                            <label for="file-upload-doctor" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500">
                                                                <span>Upload a file</span>
                                                                <input id="file-upload-doctor" type="file" class="sr-only">
                                                            </label>
                                                        </div>
                                                        <p class="text-xs text-slate-500">PDF, PNG, JPG, DICOM up to 10MB</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex justify-end pt-4">
                                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-6 rounded-lg transition-all shadow hover:shadow-lg flex items-center gap-2">
                                                <i data-lucide="send" class="w-4 h-4"></i>
                                                Send to Patient
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div id="file-preview-modal-doctor" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
            <div id="modal-content-doctor" class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col transition-all duration-300 transform scale-95 opacity-0">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 id="modal-title-doctor" class="text-lg font-semibold">File Preview</h3>
                    <button id="close-modal-button-doctor" class="text-slate-400 hover:text-slate-600">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
                <div id="modal-body-doctor" class="flex-grow p-4 overflow-auto custom-scrollbar">
                    <img id="modal-image-doctor" src="" alt="File Preview" class="w-full h-auto rounded-lg">
                </div>
                <div class="p-4 bg-slate-50 border-t flex justify-end gap-3">
                    <button id="modal-download-btn-doctor" class="bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 text-sm flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> Download
                    </button>
                    <button id="modal-close-btn-footer-doctor" class="bg-slate-200 text-slate-700 py-2 px-4 rounded-lg font-semibold hover:bg-slate-300 text-sm">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="messages-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between p-4 border-b">
                <div class="flex items-center gap-3">
                    <button id="back-to-conversations" class="hidden text-slate-400 hover:text-slate-600"><i data-lucide="arrow-left" class="h-6 w-6"></i></button>
                    <h3 id="messages-modal-title" class="text-lg font-semibold">Messages</h3>
                </div>
                <button id="close-messages-modal" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="h-6 w-6"></i></button>
            </div>
            <div id="conversation-view" class="flex-grow flex flex-col p-6 space-y-4 hidden">
                <div id="message-container" class="flex-grow overflow-y-auto modal-scrollbar space-y-4">
                </div>
                <form id="message-form" class="flex gap-2">
                    <input type="text" id="message-input" placeholder="Type a message..." class="flex-grow px-4 py-2 bg-slate-100 border border-slate-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 flex items-center gap-2">
                        <i data-lucide="send" class="w-4 h-4"></i>
                        <span class="hidden sm:block">Send</span>
                    </button>
                </form>
            </div>
            <div id="select-conversation-view" class="flex-grow flex flex-col p-6 space-y-4">
                <div id="conversations-list" class="flex-grow overflow-y-auto modal-scrollbar space-y-4">
                    <p class="text-sm text-slate-500 text-center">No active conversations. Start a new one.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, onSnapshot, orderBy, addDoc, serverTimestamp, runTransaction, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Configuration & Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
          apiKey: "AIzaSyCuPAopZ-hTlKXsObB8h-F_x18C-QDPcAo",
          authDomain: "mediconnect-app-48c6b.firebaseapp.com",
          projectId: "mediconnect-app-48c6b",
          storageBucket: "mediconnect-app-48c6b.firebasestorage.app",
          messagingSenderId: "195674005603",
          appId: "1:195674005603:web:7e7e06eefb3c4a5f3e1856",
          measurementId: "G-9E81B8HZXT"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser;
        let userRole;
        let patientState = {
            records: [],
            healthData: {
                bloodPressure: { systolic: 120, diastolic: 80, history: [{ month: 'Mar', value: 125 }, { month: 'Apr', value: 122 }, { month: 'May', value: 128 }, { month: 'Jun', value: 124 }, { month: 'Jul', value: 121 }, { month: 'Aug', value: 120 }] },
                sugarLevel: { value: 95, unit: "mg/dL", status: "Normal" },
                heartRate: { value: 68, unit: 'bpm', status: 'Resting', history: [{ month: 'Mar', value: 72 }, { month: 'Apr', value: 70 }, { month: 'May', value: 68 }, { month: 'Jun', value: 69 }, { month: 'Jul', value: 67 }, { month: 'Aug', value: 68 }] },
                bloodOxygen: { value: 98, unit: '%', status: 'Normal', history: [{ month: 'Mar', value: 99 }, { month: 'Apr', value: 98 }, { month: 'May', value: 97 }, { month: 'Jun', value: 98 }, { month: 'Jul', value: 99 }, { month: 'Aug', value: 98 }] },
                ecg: { status: 'Normal Sinus Rhythm', summary: 'No abnormalities detected.' },
                sleep: { duration: '7h 45m', quality: 'Good', deepSleep: '2h 30m' }
            },
            permissions: [],
            patientDetails: {},
            accessLog: [],
            aiReport: null,
            activeVital: 'bloodPressure',
            appointments: [],
        };
        let doctorState = {
            activePatientUid: null,
            patients: [],
            doctorDetails: {},
        };

        const showLoading = (show) => {
            document.getElementById('loading-modal').classList.toggle('hidden', !show);
        };
        
        const showMessage = (title, message) => {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').textContent = message;
            document.getElementById('confirm-action').textContent = "OK";
            document.getElementById('cancel-confirmation').classList.add('hidden');
            modal.classList.remove('hidden');
            
            const handleClose = () => {
                modal.classList.add('hidden');
                document.getElementById('cancel-confirmation').classList.remove('hidden');
                document.getElementById('confirm-action').removeEventListener('click', handleClose);
            };
            document.getElementById('confirm-action').addEventListener('click', handleClose);
        };

        const handleLogout = async () => {
            showConfirmation(
                'Confirm Logout',
                'Are you sure you want to log out?',
                async () => {
                    await signOut(auth);
                    userRole = null;
                    showView('landing');
                },
                'Log Out'
            );
        };

        const fetchAndSetUserData = async (uid) => {
            try {
                const userRef = doc(db, `artifacts/${appId}/users/${uid}`);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    userRole = userData.role;
                    if (userRole === 'patient') {
                        patientState.patientDetails = userData.details;
                        showView('patientDashboard');
                    } else if (userRole === 'doctor') {
                        doctorState.doctorDetails = userData.details;
                        showView('doctorDashboard');
                    }
                } else {
                    console.log("New user signing up:", uid);
                    showView('landing');
                    showAuthView('roleSelect');
                }
            } catch (e) {
                console.error("Error fetching user data:", e);
                await signOut(auth);
                showView('landing');
            }
            showLoading(false);
        };

        const views = {
            landing: document.getElementById('landing-page-view'),
            patientDashboard: document.getElementById('patient-dashboard-view'),
            doctorDashboard: document.getElementById('doctor-dashboard-view'),
        };

        const showView = (viewName) => {
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
                if (viewName === 'patientDashboard') {
                    initializePatientDashboard();
                } else if (viewName === 'doctorDashboard') {
                    initializeDoctorDashboard();
                }
            }
            lucide.createIcons();
        };

        const initLandingPage = () => {
            const menuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            menuButton.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));

            const authModal = document.getElementById('auth-modal');
            const modalContent = document.getElementById('modal-content');
            const closeModalButton = document.getElementById('close-modal-button');
            const authTriggers = document.querySelectorAll('.auth-trigger, #open-auth-modal-header');

            const authViews = {
                initial: document.getElementById('initial-view'),
                roleSelect: document.getElementById('role-select-view'),
                patientForm: document.getElementById('patient-form-view'),
                doctorForm: document.getElementById('doctor-form-view'),
                success: document.getElementById('success-view'),
            };
            const modalTitle = document.getElementById('modal-title');

            const showAuthView = (viewName) => {
                Object.values(authViews).forEach(view => view.classList.add('hidden'));
                if (authViews[viewName]) {
                    authViews[viewName].classList.remove('hidden');
                }
                const titles = {
                    initial: 'Welcome to MediConnect',
                    roleSelect: 'Create Your Account',
                    patientForm: 'Patient Registration',
                    doctorForm: 'Doctor Registration',
                    success: 'Success!'
                };
                modalTitle.textContent = titles[viewName] || 'Welcome';
            };

            const openAuthModal = () => {
                authModal.classList.remove('hidden');
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            };

            const closeAuthModal = () => {
                modalContent.classList.add('scale-95', 'opacity-0');
                modalContent.classList.remove('scale-100', 'opacity-100');
                setTimeout(() => {
                    authModal.classList.add('hidden');
                    showAuthView('initial');
                }, 300);
            };

            authTriggers.forEach(trigger => trigger.addEventListener('click', openAuthModal));
            closeModalButton.addEventListener('click', closeAuthModal);
            authModal.addEventListener('click', (e) => {
                if (e.target === authModal) closeAuthModal();
            });

            document.getElementById('go-to-role-select').addEventListener('click', () => showAuthView('roleSelect'));
            document.querySelectorAll('.back-to-login').forEach(btn => btn.addEventListener('click', () => showAuthView('initial')));
            document.querySelectorAll('.back-to-roles').forEach(btn => btn.addEventListener('click', () => showAuthView('roleSelect')));

            // Google Sign-In button logic
            const googleSignInBtn = document.getElementById('google-sign-in-btn');
            googleSignInBtn.addEventListener('click', async () => {
                showLoading(true);
                const provider = new GoogleAuthProvider();
                try {
                    const result = await signInWithPopup(auth, provider);
                    const user = result.user;
                    const userRef = doc(db, `artifacts/${appId}/users/${user.uid}`);
                    const userSnap = await getDoc(userRef);

                    if (userSnap.exists()) {
                        // User already exists, proceed to dashboard
                        // onAuthStateChanged will handle this
                    } else {
                        // New user, redirect to role selection
                        showAuthView('roleSelect');
                        showLoading(false);
                    }
                } catch (error) {
                    console.error("Google Sign-In failed:", error);
                    showMessage("Sign-in Failed", `Google Sign-in failed: ${error.message}`);
                }
            });


            document.getElementById('select-patient-role').addEventListener('click', () => {
                userRole = 'patient';
                showAuthView('patientForm');
            });
            document.getElementById('select-doctor-role').addEventListener('click', () => {
                userRole = 'doctor';
                showAuthView('doctorForm');
            });

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                showLoading(true);
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (e) {
                    showLoading(false);
                    console.error("Login failed:", e);
                    showMessage("Login Failed", `Login failed: ${e.message}`);
                }
            });

            document.getElementById('patient-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('patient-signup-email').value;
                const password = document.getElementById('patient-signup-password').value;
                const name = document.getElementById('patient-name-input').value;
                showLoading(true);

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const uid = userCredential.user.uid;
                    const userData = {
                        role: 'patient',
                        details: {
                            name,
                            email,
                            dob: document.getElementById('patient-dob-input').value,
                            gender: document.getElementById('patient-gender-select').value,
                            contact: document.getElementById('patient-contact-input').value,
                            emergencyContact: document.getElementById('patient-emergency-contact-input').value,
                            bloodGroup: document.getElementById('patient-blood-group-input').value,
                            allergies: document.getElementById('patient-allergies-input').value,
                            medications: document.getElementById('patient-medications-textarea').value,
                            history: document.getElementById('patient-history-textarea').value,
                            consent_doctors: document.getElementById('consent-doctors').checked,
                            consent_research: document.getElementById('consent-research').checked,
                            patientId: `PID${Math.floor(Math.random() * 100000)}`
                        }
                    };
                    await setDoc(doc(db, `artifacts/${appId}/users/${uid}`), userData);
                    patientState.patientDetails = userData.details;
                    showLoading(false);
                    showAuthView('success');
                } catch (e) {
                    console.error("Patient signup failed:", e);
                    showLoading(false);
                    showMessage("Signup Failed", `Signup failed: ${e.message}`);
                }
            });

            document.getElementById('doctor-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('doctor-signup-email').value;
                const password = document.getElementById('doctor-signup-password').value;
                const name = document.getElementById('doctor-name-input').value;
                showLoading(true);

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const uid = userCredential.user.uid;
                    const userData = {
                        role: 'doctor',
                        details: {
                            name,
                            email,
                            specialization: document.getElementById('doctor-specialization-input').value,
                            experience: document.getElementById('doctor-experience-input').value,
                            license: document.getElementById('doctor-license-input').value,
                            hospital: document.getElementById('doctor-hospital-input').value,
                            contactEmail: document.getElementById('doctor-contact-email-input').value,
                            doctorId: `DOC${Math.floor(Math.random() * 100000)}`
                        }
                    };
                    await setDoc(doc(db, `artifacts/${appId}/users/${uid}`), userData);
                    doctorState.doctorDetails = userData.details;
                    showLoading(false);
                    showAuthView('success');
                } catch (e) {
                    console.error("Doctor signup failed:", e);
                    showLoading(false);
                    showMessage("Signup Failed", `Signup failed: ${e.message}`);
                }
            });
            
            document.getElementById('go-to-dashboard-btn').addEventListener('click', () => {
                closeAuthModal();
            });

            showAuthView('initial');
        };

        const patientDashboardInitialized = false;
        
        const initPatientState = async () => {
            onSnapshot(doc(db, `artifacts/${appId}/users/${currentUser.uid}`), (docSnap) => {
                if (docSnap.exists()) {
                    patientState.patientDetails = docSnap.data().details;
                    renderHeader();
                }
            });

            onSnapshot(collection(db, `artifacts/${appId}/users/${currentUser.uid}/records`), (snapshot) => {
                patientState.records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderHealthSnapshot();
            });

            const appointmentsRef = collection(db, `artifacts/${appId}/public/data/appointments`);
            const q = query(appointmentsRef, where('patientId', '==', currentUser.uid));
            onSnapshot(q, (snapshot) => {
                patientState.appointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMyAppointments();
            });
        };

        const initializePatientDashboard = async () => {
            if (patientDashboardInitialized) return;
            
            await initPatientState();
            
            const DOMElements = {
                patientMainSections: document.querySelectorAll('.patient-main-section'),
                patientNavLinks: document.querySelectorAll('.patient-nav-link'),
                profileModal: document.getElementById('profile-modal'),
                profileModalContent: document.getElementById('profile-modal-content'),
                uploadModal: document.getElementById('upload-modal'),
                uploadModalContent: document.getElementById('upload-modal-content'),
                headerPatientName: document.getElementById('header-patient-name'),
                headerPatientId: document.getElementById('header-patient-id'),
                healthSnapshotList: document.getElementById('health-snapshot-list'),
                blockchainAnchor: document.getElementById('blockchain-anchor'),
                vitalsFilterContainer: document.getElementById('vitals-filter-container'),
                vitalsDisplayContainer: document.getElementById('vitals-display-container'),
                aiReportContent: document.getElementById('ai-report-content'),
                permissionsContainer: document.getElementById('permissions-container'),
                accessLogContainer: document.getElementById('access-log-container'),
                profileButton: document.getElementById('profile-button'),
                closeProfileModalBtn: document.getElementById('close-profile-modal'),
                cancelProfileSaveBtn: document.getElementById('cancel-profile-save'),
                saveProfileBtn: document.getElementById('save-profile'),
                openUploadModalBtn: document.getElementById('open-upload-modal-btn'),
                closeUploadModalBtn: document.getElementById('close-upload-modal'),
                cancelUploadBtn: document.getElementById('cancel-upload'),
                uploadReportBtn: document.getElementById('upload-report-btn'),
                exploreAiBtn: document.getElementById('explore-ai-btn'),
                copyHashBtn: document.getElementById('copy-hash-btn'),
                runAiBtn: document.getElementById('run-ai-btn'),
                profileNameInput: document.getElementById('profile-name'),
                profileDobInput: document.getElementById('profile-dob'),
                profileGenderInput: document.getElementById('profile-gender'),
                profileContactInput: document.getElementById('profile-contact'),
                profileEmergencyInput: document.getElementById('profile-emergency'),
                doctorListContainer: document.getElementById('doctor-list'),
                myAppointmentsList: document.getElementById('my-appointments-list'),
                composeMessageBtn: document.getElementById('compose-message-btn'),
            };

            document.getElementById('logout-patient').addEventListener('click', handleLogout);

            const switchSection = (id) => {
                DOMElements.patientMainSections.forEach(section => {
                    section.classList.add('hidden');
                });
                const targetSection = document.getElementById(id);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                }
            };

            DOMElements.patientNavLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = e.target.dataset.section;
                    if (id) {
                        if (id === 'messages-patient-section') {
                            openMessageModal();
                            return;
                        }
                        switchSection(id);
                    }
                });
            });

            const renderHeader = () => {
                DOMElements.headerPatientName.textContent = patientState.patientDetails.name;
                DOMElements.headerPatientId.textContent = `Patient ID: ${patientState.patientDetails.patientId}`;
            };

            const callBlockchainAPI = (action, data) => {
                const crypto = window.crypto || window.msCrypto;
                const text = `${action}:${JSON.stringify(data)}:${new Date().toISOString()}`;
                const hash = `0x${text.length}${crypto?.getRandomValues(new Uint32Array(1))[0].toString(16)}`.slice(0, 20);
                console.log(`[BLOCKCHAIN API] Action: ${action}, Hash: ${hash}`);
                return hash;
            };

            const renderHealthSnapshot = () => {
                DOMElements.healthSnapshotList.innerHTML = patientState.records.map(r => 
                    `<li class="flex justify-between items-start bg-white p-3 rounded-lg shadow-sm">
                        <div class="flex-grow">
                            <div class="font-medium text-slate-800">${r.type} <span class="text-xs text-slate-400">(${r.source})</span></div>
                            <div class="text-slate-500">${r.summary || 'No summary provided.'}</div>
                            ${r.doctorsNote ? `<div class="mt-2 text-xs text-indigo-700 bg-indigo-50 p-2 rounded-lg"><span class="font-semibold">Doctor's Note:</span> ${r.doctorsNote}</div>` : ''}
                        </div>
                        <div class="text-right flex-shrink-0 ml-2">
                            <div class="text-xs text-slate-400 mb-2">${r.timestamp ? new Date(r.timestamp.toDate()).toLocaleDateString() : 'Just now'}</div>
                            <button data-record-id="${r.id}" class="delete-record-btn text-red-500 hover:text-red-700 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </li>`
                ).join('');
                DOMElements.blockchainAnchor.innerHTML = `Blockchain anchor: <span class="font-mono">${callBlockchainAPI('get_latest_block', patientState.records).slice(0, 20)}...</span>`;
                lucide.createIcons();
            };

            const handleDeleteRecord = async (recordId) => {
                showConfirmation(
                    'Delete Record',
                    'This action cannot be undone. The record will be permanently deleted.',
                    async () => {
                        await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUser.uid}/records`, recordId));
                        logAction(`Record deleted: ID ${recordId}`);
                    },
                    'Delete'
                );
            };

            const renderVitals = () => {
                const vital_filters = [{ id: 'bloodPressure', label: 'Blood Pressure', icon: 'heart' }, { id: 'heartRate', label: 'Heart Rate', icon: 'activity' }, { id: 'bloodOxygen', label: 'Blood Oxygen', icon: 'wind' }, { id: 'sugarLevel', label: 'Blood Sugar', icon: 'droplet' }, { id: 'ecg', label: 'ECG', icon: 'activity' }, { id: 'sleep', label: 'Sleep', icon: 'bed-double' }];
                DOMElements.vitalsFilterContainer.innerHTML = vital_filters.map(filter => `<button data-vital="${filter.id}" class="vital-filter-btn flex items-center gap-2 px-3 py-2 font-semibold text-sm rounded-lg transition-colors ${patientState.activeVital === filter.id ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}"><i data-lucide="${filter.icon}" class="w-4 h-4"></i> <span>${filter.label}</span></button>`).join('');
                const ecgWaveformHTML = `<svg viewBox="0 0 100 40" class="w-full h-24 text-teal-500"><path d="M 0 20 L 10 20 L 12 15 L 16 25 L 20 20 L 22 22 L 24 18 L 26 20 L 40 20 Q 42 20 43 10 T 46 20 L 55 20 L 57 24 L 59 16 L 61 20 L 80 20 L 82 15 L 86 25 L 90 20 L 100 20" stroke="currentColor" strokeWidth="1" fill="none" /></svg>`;
                const createHealthHistoryGraphHTML = (data, metric, color) => {
                    if (!data || data.length === 0) return `<div class="bg-slate-50 p-4 rounded-lg border flex items-center justify-center h-48"><p class="text-sm text-slate-400">No history data available</p></div>`;
                    const maxVal = Math.max(...data.map(d => d.value)) + 10, minVal = Math.min(...data.map(d => d.value)) - 10;
                    const points = data.map((d, i) => `${(i / (data.length - 1)) * 100},${100 - ((d.value - minVal) / (maxVal - minVal)) * 100}`).join(' ');
                    const circles = data.map((d, i) => `<circle key="${i}" cx="${(i / (data.length - 1)) * 100}" cy="${100 - ((d.value - minVal) / (maxVal - minVal)) * 100}" r="1.5" fill="${color}" />`).join('');
                    const months = data.map(d => `<span>${d.month}</span>`).join('');
                    return `<div class="mt-4"><h4 class="text-sm font-semibold text-slate-600 mb-2">${metric} History (Last 6 Months)</h4><div class="bg-slate-50 p-4 rounded-lg border"><svg viewBox="0 0 100 100" class="w-full h-40" preserveAspectRatio="none"><text x="0" y="5" font-size="8" fill="#94a3b8">${maxVal}</text><text x="0" y="98" font-size="8" fill="#94a3b8">${minVal}</text><line x1="5" x2="100" y1="5" y2="5" stroke="#e2e8f0" stroke-width="0.5" stroke-dasharray="2"/><line x1="5" x2="100" y1="50" y2="50" stroke="#e2e8f0" stroke-width="0.5" stroke-dasharray="2"/><line x1="5" x2="100" y1="95" y2="95" stroke="#e2e8f0" stroke-width="0.5" stroke-dasharray="2"/><polyline fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" points="${points}" />${circles}</svg><div class="flex justify-between text-xs text-slate-400 mt-2">${months}</div></div></div>`;
                };
                const vital_components_html = {
                    bloodPressure: `<div class="bg-white rounded-2xl p-6 border"> <div class="flex items-center gap-3 mb-3"><div class="bg-red-100 p-2 rounded-full"><i data-lucide="heart" class="w-6 h-6 text-red-500"></i></div><h3 class="text-xl font-semibold text-slate-800">Blood Pressure</h3></div> <p class="text-4xl font-bold text-slate-800">${patientState.healthData.bloodPressure.systolic}<span class="text-2xl text-slate-500">/${patientState.healthData.bloodPressure.diastolic}</span><span class="text-lg ml-2 text-slate-500">mmHg</span></p> <p class="text-sm text-green-600 font-medium mt-1">Normal</p> ${createHealthHistoryGraphHTML(patientState.healthData.bloodPressure.history, "Systolic BP", "#ef4444")} </div>`,
                    heartRate: `<div class="bg-white rounded-2xl p-6 border"> <div class="flex items-center gap-3 mb-3"><div class="bg-rose-100 p-2 rounded-full"><i data-lucide="activity" class="w-6 h-6 text-rose-500"></i></div><h3 class="text-xl font-semibold text-slate-800">Heart Rate</h3></div> <p class="text-4xl font-bold text-slate-800">${patientState.healthData.heartRate.value}<span class="text-lg ml-2 text-slate-500">${patientState.healthData.heartRate.unit}</span></p> <p class="text-sm text-green-600 font-medium mt-1">${patientState.healthData.heartRate.status}</p> ${createHealthHistoryGraphHTML(patientState.healthData.heartRate.history, "Resting Heart Rate", "#f43f5e")} </div>`,
                    bloodOxygen: `<div class="bg-white rounded-2xl p-6 border"> <div class="flex items-center gap-3 mb-3"><div class="bg-cyan-100 p-2 rounded-full"><i data-lucide="wind" class="w-6 h-6 text-cyan-500"></i></div><h3 class="text-xl font-semibold text-slate-800">Blood Oxygen (SpO2)</h3></div> <p class="text-4xl font-bold text-slate-800">${patientState.healthData.bloodOxygen.value}<span class="text-lg ml-2 text-slate-500">${patientState.healthData.bloodOxygen.unit}</span></p> <p class="text-sm text-green-600 font-medium mt-1">${patientState.healthData.bloodOxygen.status}</p> ${createHealthHistoryGraphHTML(patientState.healthData.bloodOxygen.history, "SpO2 Level", "#06b6d4")} </div>`,
                    ecg: `<div class="bg-white rounded-2xl p-6 border"> <div class="flex items-center gap-3 mb-3"><div class="bg-teal-100 p-2 rounded-full"><i data-lucide="activity" class="w-6 h-6 text-teal-500"></i></div><h3 class="text-xl font-semibold text-slate-800">ECG</h3></div> <div class="mt-4 p-4 bg-slate-50 rounded-lg border">${ecgWaveformHTML}</div> <p class="text-lg font-semibold text-slate-800 mt-4">${patientState.healthData.ecg.status}</p> <p class="text-sm text-slate-500 mt-1">${patientState.healthData.ecg.summary}</p> </div>`,
                    sleep: `<div class="bg-white rounded-2xl p-6 border"> <div class="flex items-center gap-3 mb-3"><div class="bg-indigo-100 p-2 rounded-full"><i data-lucide="bed-double" class="w-6 h-6 text-indigo-500"></i></div><h3 class="text-xl font-semibold text-slate-800">Sleep Pattern</h3></div> <div class="grid grid-cols-3 gap-4 text-center mt-4"> <div><p class="text-2xl font-bold">${patientState.healthData.sleep.duration}</p><p class="text-xs text-slate-500">Total Sleep</p></div> <div><p class="text-2xl font-bold">${patientState.healthData.sleep.deepSleep}</p><p class="text-xs text-slate-500">Deep Sleep</p></div> <div><p class="text-2xl font-bold">${patientState.healthData.sleep.quality}</p><p class="text-xs text-slate-500">Quality</p></div> </div> ${createHealthHistoryGraphHTML([], "Sleep Duration", "#6366f1")} </div>`,
                    sugarLevel: `<div class="bg-white rounded-2xl p-6 border"> <div class="flex items-center gap-3 mb-3"><div class="bg-sky-100 p-2 rounded-full"><i data-lucide="droplet" class="w-6 h-6 text-sky-500"></i></div><h3 class="text-xl font-semibold text-slate-800">Blood Sugar</h3></div> <p class="text-4xl font-bold text-slate-800">${patientState.healthData.sugarLevel.value}<span class="text-lg ml-2 text-slate-500">${patientState.healthData.sugarLevel.unit}</span></p> <p class="text-sm text-green-600 font-medium mt-1">${patientState.healthData.sugarLevel.status}</p> ${createHealthHistoryGraphHTML([], "History", "#0ea5e9")} </div>`
                };
                let content = vital_components_html[patientState.activeVital];
                if (patientState.activeVital === 'bloodPressure') content += vital_components_html['heartRate'];
                if (patientState.activeVital === 'heartRate') content += vital_components_html['bloodPressure'];
                if (patientState.activeVital === 'bloodOxygen') content += vital_components_html['sugarLevel'];
                if (patientState.activeVital === 'sugarLevel') content += vital_components_html['bloodOxygen'];
                if (patientState.activeVital === 'ecg') content += vital_components_html['sleep'];
                if (patientState.activeVital === 'sleep') content += vital_components_html['ecg'];
                DOMElements.vitalsDisplayContainer.innerHTML = content;
                lucide.createIcons();
            };
            const renderPermissions = () => {
                DOMElements.permissionsContainer.innerHTML = patientState.permissions.map(p => `<div class="flex items-center justify-between gap-4 border rounded-lg p-3 hover:bg-slate-50 transition-colors"><div><div class="font-medium text-slate-700">${p.name}</div><div class="text-xs text-slate-400">Cardiology Research</div></div><div class="flex gap-2 items-center"><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" data-id="${p.id}" ${p.access ? 'checked' : ''} class="sr-only peer permission-toggle"><div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div><span class="ml-3 text-sm font-medium text-gray-900">${p.access ? "Allowed" : "Denied"}</span></label><button data-id="${p.id}" class="simulate-request-btn text-xs rounded px-3 py-1 border bg-white hover:bg-slate-100 transition-colors">Simulate</button></div></div>`).join('');
            };
            const logAction = async (action) => {
                const logsRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/logs`);
                await addDoc(logsRef, { action, timestamp: serverTimestamp() });
                renderAccessLog();
            };
            const renderAccessLog = () => {
                const logsRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/logs`);
                const q = query(logsRef, orderBy('timestamp', 'desc'));
                onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        DOMElements.accessLogContainer.innerHTML = `<div class="text-slate-400 p-2">No activity yet.</div>`;
                        return;
                    }
                    DOMElements.accessLogContainer.innerHTML = snapshot.docs.map(doc => {
                        const l = doc.data();
                        return `<div class="flex justify-between items-start border-b border-slate-200 pb-2 mb-2 last:border-b-0 last:mb-0"><div class="text-slate-700 font-mono pr-4">${l.action}</div><div class="text-slate-400 text-xs flex-shrink-0">${l.timestamp ? new Date(l.timestamp.toDate()).toLocaleString() : 'Just now'}</div></div>`;
                    }).join('');
                });
            };
            const renderAiReport = () => DOMElements.aiReportContent.textContent = patientState.aiReport ?? "Click button to run analysis.";

            const renderDoctorList = () => {
                const doctorsRef = collection(db, `artifacts/${appId}/users`);
                const q = query(doctorsRef, where('role', '==', 'doctor'));
                onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        DOMElements.doctorListContainer.innerHTML = `<p class="text-sm text-slate-500 text-center">No doctors found.</p>`;
                        return;
                    }
                    DOMElements.doctorListContainer.innerHTML = snapshot.docs.map(doc => {
                        const doctor = doc.data().details;
                        const avatarText = doctor.name.split(' ').map(n => n[0]).join('');
                        return `
                            <div class="bg-slate-50 p-4 rounded-lg border flex items-center gap-4">
                                <div class="w-16 h-16 rounded-full bg-slate-200 text-slate-800 flex items-center justify-center font-bold text-lg">${avatarText}</div>
                                <div class="flex-grow">
                                    <h4 class="font-semibold text-slate-800">${doctor.name}</h4>
                                    <p class="text-sm text-slate-500">${doctor.specialization}</p>
                                </div>
                                <button class="book-appointment-btn bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700" data-doctor-uid="${doc.id}" data-doctor-name="${doctor.name}">Book</button>
                            </div>
                        `;
                    }).join('');
                });
            };

            const renderMyAppointments = () => {
                if (patientState.appointments.length === 0) {
                    DOMElements.myAppointmentsList.innerHTML = `<p class="text-sm text-slate-500">You have no upcoming appointments.</p>`;
                    return;
                }
                DOMElements.myAppointmentsList.innerHTML = patientState.appointments.map(app => {
                    const statusColor = app.status === 'accepted' ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700';
                    return `
                        <div class="bg-slate-50 p-4 rounded-lg border flex items-center justify-between gap-4">
                            <div>
                                <div class="font-semibold text-slate-800">${app.doctorName}</div>
                                <div class="text-sm text-slate-500">${app.date} at ${app.time}</div>
                            </div>
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">${app.status.charAt(0).toUpperCase() + app.status.slice(1)}</span>
                        </div>
                    `;
                }).join('');
            };

            const handleBookAppointment = async (e) => {
                const doctorUid = e.target.dataset.doctorUid;
                const doctorName = e.target.dataset.doctorName;
                
                try {
                    const appointmentsRef = collection(db, `artifacts/${appId}/public/data/appointments`);
                    await addDoc(appointmentsRef, {
                        patientId: currentUser.uid,
                        patientName: patientState.patientDetails.name,
                        doctorId: doctorUid,
                        doctorName: doctorName,
                        date: '2025-09-25',
                        time: '11:00 AM',
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });
                    
                    logAction(`Booked appointment with ${doctorName}`);
                    showMessage("Success", `Your appointment request with ${doctorName} has been sent!`);
                } catch (e) {
                    console.error("Error booking appointment:", e);
                }
            };

            const toggleModal = (modal, content, show) => {
                if (show) {
                    modal.classList.remove('hidden'); modal.classList.add('flex'); modal.classList.remove('modal-leave'); if (content) content.classList.remove('modal-content-leave'); modal.classList.add('modal-enter'); if (content) content.classList.add('modal-content-enter');
                } else {
                    modal.classList.add('modal-leave'); if (content) content.classList.add('modal-content-leave'); setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('flex'); }, 300);
                }
            };

            const handleAddRecord = async () => {
                const title = document.getElementById('report-title').value, description = document.getElementById('report-description').value, doctorsNote = document.getElementById('report-doctor-note').value;
                if (!title) { showMessage("Error", "Please provide a title for the report."); return; }
                const recordsRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/records`);
                await addDoc(recordsRef, {
                    source: "Manual Upload",
                    date: new Date().toISOString().split('T')[0],
                    type: title,
                    summary: description,
                    doctorsNote: doctorsNote,
                    timestamp: serverTimestamp()
                });
                logAction(`New record added: "${title}"`);
                document.getElementById('report-title').value = ''; document.getElementById('report-description').value = ''; document.getElementById('report-doctor-note').value = '';
                toggleModal(document.getElementById('upload-modal'), document.getElementById('upload-modal-content'), false);
            };

            const handleSaveProfile = async () => {
                const patientRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}`);
                const updatedDetails = {
                    ...patientState.patientDetails,
                    name: document.getElementById('profile-name').value,
                    dob: document.getElementById('profile-dob').value,
                    gender: document.getElementById('profile-gender').value,
                    contact: document.getElementById('profile-contact').value,
                    emergencyContact: document.getElementById('profile-emergency').value
                };
                try {
                    await updateDoc(patientRef, { details: updatedDetails });
                    patientState.patientDetails = updatedDetails;
                    renderHeader();
                    toggleModal(document.getElementById('profile-modal'), document.getElementById('profile-modal-content'), false);
                } catch (e) {
                    console.error("Error updating profile:", e);
                }
            };

            document.getElementById('profile-button').addEventListener('click', () => {
                document.getElementById('profile-name').value = patientState.patientDetails.name; document.getElementById('profile-dob').value = patientState.patientDetails.dob; document.getElementById('profile-gender').value = patientState.patientDetails.gender; document.getElementById('profile-contact').value = patientState.patientDetails.contact; document.getElementById('profile-emergency').value = patientState.patientDetails.emergencyContact;
                toggleModal(document.getElementById('profile-modal'), document.getElementById('profile-modal-content'), true);
            });
            document.getElementById('close-profile-modal').addEventListener('click', () => toggleModal(document.getElementById('profile-modal'), document.getElementById('profile-modal-content'), false));
            document.getElementById('cancel-profile-save').addEventListener('click', () => toggleModal(document.getElementById('profile-modal'), document.getElementById('profile-modal-content'), false));
            document.getElementById('save-profile').addEventListener('click', handleSaveProfile);
            document.getElementById('open-upload-modal-btn').addEventListener('click', () => toggleModal(document.getElementById('upload-modal'), document.getElementById('upload-modal-content'), true));
            document.getElementById('close-upload-modal').addEventListener('click', () => toggleModal(document.getElementById('upload-modal'), document.getElementById('upload-modal-content'), false));
            document.getElementById('cancel-upload').addEventListener('click', () => toggleModal(document.getElementById('upload-modal'), document.getElementById('upload-modal-content'), false));
            document.getElementById('upload-report-btn').addEventListener('click', handleAddRecord);

            document.getElementById('doctor-list').addEventListener('click', e => {
                const bookBtn = e.target.closest('.book-appointment-btn');
                if (bookBtn) {
                    handleBookAppointment(e);
                }
            });

            document.getElementById('health-snapshot-list').addEventListener('click', e => {
                const deleteButton = e.target.closest('.delete-record-btn');
                if(deleteButton) {
                    const recordId = deleteButton.dataset.recordId;
                    handleDeleteRecord(recordId);
                }
            });

            document.getElementById('vitals-filter-container').addEventListener('click', e => {
                const button = e.target.closest('.vital-filter-btn');
                if (button) { patientState.activeVital = button.dataset.vital; renderVitals(); }
            });
            document.getElementById('permissions-container').addEventListener('click', e => {
                const toggle = e.target.closest('.permission-toggle'), button = e.target.closest('.simulate-request-btn');
                if (toggle) {
                    const id = toggle.dataset.id, permission = patientState.permissions.find(p => p.id === id);
                    if (permission) { permission.access = !permission.access; logAction(`${permission.name} permission ${permission.access ? "granted" : "revoked"}`); renderPermissions(); }
                }
                if (button) {
                    const id = button.dataset.id, p = patientState.permissions.find(x => x.id === id);
                    if (p) { logAction(`${p.name} requested data: ${p.access ? "GRANTED" : "DENIED"}`); }
                }
            });
            document.getElementById('run-ai-btn').addEventListener('click', () => {
                patientState.aiReport = ["1. Population data suggests a slight increase in hypertension risk for this demographic.", "2. Analysis of similar patient profiles indicates a high success rate with preventative lifestyle changes.", "3. Recommend flagging patients with consistent BP readings above 130/85 for proactive outreach."].join("\n");
                logAction(`AI population analysis executed`);
                renderAiReport();
            });
            document.getElementById('copy-hash-btn').addEventListener('click', () => navigator.clipboard.writeText(callBlockchainAPI('get_latest_block', patientState.records)).then(() => showMessage("Copied", "Blockchain hash copied to clipboard!")).catch(err => console.error('Failed to copy hash: ', err)));
            document.getElementById('explore-ai-btn').addEventListener('click', () => document.getElementById('ai')?.scroll-into-view({ behavior: 'smooth' }));
            
            document.getElementById('compose-message-btn').addEventListener('click', () => {
                openMessageModal();
            });

            renderHeader(); renderVitals(); renderPermissions(); renderAccessLog(); renderDoctorList(); lucide.createIcons();
            patientDashboardInitialized = true;
        };

        // --- DOCTOR DASHBOARD LOGIC ---
        let doctorDashboardInitialized = false;
        
        const fetchDoctorData = () => {
            const userRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}`);
            const usersRef = collection(db, `artifacts/${appId}/users`);
            const q = query(usersRef, where('role', '==', 'patient'));

            onSnapshot(userRef, (docSnap) => {
                if (docSnap.exists()) {
                    doctorState.doctorDetails = docSnap.data().details;
                    document.getElementById('doctor-sidebar-name').textContent = doctorState.doctorDetails.name;
                    document.getElementById('doctor-sidebar-id').textContent = `ID: ${doctorState.doctorDetails.doctorId}`;
                    const avatarText = doctorState.doctorDetails.name.split(' ').map(n=>n[0]).join('');
                    document.getElementById('doctor-avatar').src = `https://placehold.co/100x100/a7c5fd/333333?text=${avatarText}`;
                    lucide.createIcons();
                }
            });

            onSnapshot(q, (snapshot) => {
                doctorState.patients = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const nameParts = data.details.name.split(' ');
                    const initials = nameParts.length > 1 ? `${nameParts[0][0]}${nameParts[1][0]}` : nameParts[0][0];
                    return {
                        id: doc.id,
                        name: data.details.name,
                        avatar: `https://placehold.co/100x100/cce7f1/444444?text=${initials}`,
                        ...data.details
                    };
                });
                displayPatients(doctorState.patients);
            });
        };

        const initializeDoctorDashboard = async () => {
            if (doctorDashboardInitialized) return;
            
            await fetchDoctorData();
            
            const searchInput = document.querySelector('#doctor-dashboard-view #patient-search-input');
            const patientList = document.querySelector('#doctor-dashboard-view #patient-list');
            const noResults = document.querySelector('#doctor-dashboard-view #no-results');
            const navTabs = document.querySelectorAll('.nav-tab');
            const dashboardSections = {
                'patient-search-view': document.getElementById('patient-search-view'),
                'appointments-doctor-section': document.getElementById('appointments-doctor-section'),
                'messages-doctor-section': document.getElementById('messages-doctor-section'),
                'settings-doctor-section': document.getElementById('settings-doctor-section'),
                'patient-profile-view': document.getElementById('patient-profile-view'),
            };
            const tabButtons = document.querySelectorAll('#doctor-dashboard-view .dashboard-tab-button');
            const tabContents = document.querySelectorAll('#doctor-dashboard-view .dashboard-tab-content');
            const backToSearchBtn = document.getElementById('back-to-search');
            
            const modal = document.getElementById('file-preview-modal-doctor');
            const modalContent = document.getElementById('modal-content-doctor');
            const closeModalButton = document.getElementById('close-modal-button-doctor');
            const modalCloseFooter = document.getElementById('modal-close-btn-footer-doctor');
            const modalTitle = document.getElementById('modal-title-doctor');
            const modalImage = document.getElementById('modal-image-doctor');
            const modalDownloadBtn = document.getElementById('modal-download-btn-doctor');
            let currentFileUrl = '';
            
            document.getElementById('logout-doctor').addEventListener('click', handleLogout);
            document.getElementById('message-patient-btn').addEventListener('click', () => {
                const activePatient = doctorState.patients.find(p => p.id === doctorState.activePatientUid);
                if (activePatient) {
                    openMessageModal(activePatient.id);
                }
            });
            
            const pendingApptsList = document.getElementById('pending-appointments-list');
            const acceptedApptsList = document.getElementById('accepted-appointments-list');
            
            const renderPatientCard = (patient) => {
                const consentColors = { 'All Records': 'bg-green-100 text-green-800', 'Lab Only': 'bg-amber-100 text-amber-800', 'Prescription Only': 'bg-blue-100 text-blue-800', 'None': 'bg-slate-100 text-slate-800' };
                return `<div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200/80 hover:shadow-md hover:border-blue-400 transition-all cursor-pointer" data-patient-uid="${patient.id}"><div class="flex items-center gap-4"><img src="${patient.avatar}" alt="${patient.name}" class="w-16 h-16 rounded-full"><div class="flex-1"><p class="font-bold text-lg text-slate-800">${patient.name}</p><p class="text-sm text-slate-500">ID: ${patient.patientId}</p></div></div><div class="mt-4 pt-4 border-t border-slate-200 flex justify-between items-center"><p class="text-sm text-slate-600">Consent Level:</p><span class="px-2 py-1 text-xs font-semibold rounded-full ${consentColors[patient.consent] || 'bg-slate-100 text-slate-800'}">${patient.consent}</span></div></div>`;
            };
            const displayPatients = (patients) => {
                if (patients.length === 0) {
                    patientList.innerHTML = ''; noResults.classList.remove('hidden'); noResults.querySelector('p').textContent = 'No patients found matching your search.';
                } else {
                    patientList.innerHTML = patients.map(renderPatientCard).join(''); noResults.classList.add('hidden');
                }
            };

            const populatePatientProfile = async (patientUid) => {
                doctorState.activePatientUid = patientUid;
                const patientRef = doc(db, `artifacts/${appId}/users/${patientUid}`);
                const patientSnap = await getDoc(patientRef);
                if (!patientSnap.exists()) return;

                const patient = patientSnap.data().details;

                const avatarText = patient.name.split(' ').map(n=>n[0]).join('');
                document.querySelector('#doctor-dashboard-view #patient-avatar').src = `https://placehold.co/100x100/cce7f1/444444?text=${avatarText}`;
                document.querySelector('#doctor-dashboard-view #patient-name').textContent = patient.name;
                const age = new Date().getFullYear() - new Date(patient.dob).getFullYear();
                document.querySelector('#doctor-dashboard-view #patient-meta').textContent = `ID: ${patient.patientId} • ${patient.gender}, ${age} years old`;
                document.querySelector('#doctor-dashboard-view #patient-contact-info').innerHTML = `<p><i data-lucide="phone" class="w-4 h-4 inline-block mr-2 text-slate-400"></i> ${patient.contact}</p><p><i data-lucide="mail" class="w-4 h-4 inline-block mr-2 text-slate-400"></i> ${patient.email}</p><p><i data-lucide="contact" class="w-4 h-4 inline-block mr-2 text-slate-400"></i> ${patient.emergencyContact}</p>`;
                document.querySelector('#doctor-dashboard-view #ai-summary').textContent = patient.ai?.summary || 'No AI summary available.';
                document.querySelector('#doctor-dashboard-view #red-flags').textContent = patient.ai?.flags || 'No red flags detected.';
                document.querySelector('#doctor-dashboard-view #personal-info').innerHTML = `<p class="flex justify-between"><span>DOB:</span> <span class="font-medium">${patient.dob}</span></p><p class="flex justify-between"><span>Blood Group:</span> <span class="font-medium">${patient.bloodGroup}</span></p>`;
                document.querySelector('#doctor-dashboard-view #medical-history').innerHTML = `<p><strong>Allergies:</strong> ${patient.allergies}</p><p><strong>Chronic Conditions:</strong> N/A</p><p><strong>Past History:</strong> ${patient.history}</p>`;
                document.querySelector('#doctor-dashboard-view #lifestyle-info').innerHTML = `<p class="flex justify-between"><span>Medications:</span> <span class="font-medium">${patient.medications}</span></p><p class="flex justify-between"><span>Past History:</span> <span class="font-medium">${patient.history}</span></p>`;
                
                const timelineContainer = document.querySelector('#doctor-dashboard-view #records-timeline');
                const recordsRef = collection(db, `artifacts/${appId}/users/${patientUid}/records`);
                const q = query(recordsRef, orderBy('timestamp', 'desc'));
                onSnapshot(q, (snapshot) => {
                    const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const iconMap = { 'Consultation': '<i data-lucide="clipboard-pen" class="w-5 h-5"></i>', 'Lab Report': '<i data-lucide="beaker" class="w-5 h-5"></i>', 'X-Ray': '<i data-lucide="bone" class="w-5 h-5"></i>', 'Prescription': '<i data-lucide="pilcrow" class="w-5 h-5"></i>' };
                    timelineContainer.innerHTML = records.map(record => `<div class="relative"><div class="absolute -left-[37px] top-1 w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center">${iconMap[record.type] || '<i data-lucide="file-text" class="w-5 h-5"></i>'}</div><div class="ml-4"><p class="text-xs text-slate-500">${new Date(record.timestamp.toDate()).toLocaleDateString()}</p><h4 class="font-semibold">${record.title}</h4><p class="text-sm text-slate-600">${record.summary}</p>${record.doctorsNote ? `<p class="text-sm text-slate-600 mt-1"><strong>Doctor's Note:</strong> ${record.doctorsNote}</p>` : ''}</div></div>`).join('');
                });
                
                document.getElementById('consult-patient-avatar').src = `https://placehold.co/100x100/cce7f1/444444?text=${avatarText}`;
                document.getElementById('consult-patient-name').textContent = patient.name;
                document.getElementById('consult-patient-id').textContent = `ID: ${patient.patientId}`;
                
                lucide.createIcons();
            };

            const showDoctorSection = (sectionId) => {
                document.querySelectorAll('.doctor-main-section').forEach(section => section.classList.add('hidden'));
                const targetSection = document.getElementById(sectionId);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                }

                navTabs.forEach(tab => {
                    const isCurrent = tab.dataset.target === sectionId;
                    tab.classList.toggle('bg-blue-50', isCurrent);
                    tab.classList.toggle('text-blue-700', isCurrent);
                    tab.classList.toggle('bg-white', !isCurrent);
                    tab.classList.toggle('text-slate-600', !isCurrent);
                });

                if (sectionId === 'patient-search-view') {
                    displayPatients(doctorState.patients);
                } else if (sectionId === 'appointments-doctor-section') {
                    renderDoctorAppointments();
                } else if (sectionId === 'messages-doctor-section') {
                    openMessageModal();
                }
            };

            const openFileModal = (fileUrl, title) => {
                currentFileUrl = fileUrl; modalTitle.textContent = title; modalImage.src = fileUrl; modal.classList.remove('hidden');
                setTimeout(() => { modalContent.classList.remove('scale-95', 'opacity-0'); modalContent.classList.add('scale-100', 'opacity-100'); }, 10);
            };
            const closeFileModal = () => {
                modalContent.classList.add('scale-95', 'opacity-0'); modalContent.classList.remove('scale-100', 'opacity-100');
                setTimeout(() => modal.classList.add('hidden'), 300);
            };

            const switchTab = (tabId) => {
                tabContents.forEach(content => content.classList.add('hidden'));
                document.getElementById(`${tabId}-content`).classList.remove('hidden');
                tabButtons.forEach(button => {
                    button.classList.toggle('bg-blue-600', button.dataset.tab === tabId);
                    button.classList.toggle('text-white', button.dataset.tab === tabId);
                    button.classList.toggle('bg-white', button.dataset.tab !== tabId);
                    button.classList.toggle('text-slate-700', button.dataset.tab !== tabId);
                });
            };
            
            const renderDoctorAppointments = () => {
                const pendingApptsList = document.getElementById('pending-appointments-list');
                const acceptedApptsList = document.getElementById('accepted-appointments-list');
                
                const allAppointmentsRef = collection(db, `artifacts/${appId}/public/data/appointments`);
                const q = query(allAppointmentsRef, where('doctorId', '==', currentUser.uid));

                onSnapshot(q, (snapshot) => {
                    const pendingAppts = [];
                    const acceptedAppts = [];
                    snapshot.forEach(doc => {
                        const appt = { id: doc.id, ...doc.data() };
                        if (appt.status === 'pending') {
                            pendingAppts.push(appt);
                        } else if (appt.status === 'accepted') {
                            acceptedAppts.push(appt);
                        }
                    });

                    if (pendingAppts.length > 0) {
                        pendingApptsList.innerHTML = pendingAppts.map(appt => `
                            <div class="bg-amber-50 p-4 rounded-lg border border-amber-200 flex flex-col sm:flex-row items-center justify-between gap-4">
                                <div class="flex-grow">
                                    <div class="font-semibold text-slate-800">New Request from ${appt.patientName}</div>
                                    <div class="text-sm text-slate-600">On ${appt.date} at ${appt.time}</div>
                                </div>
                                <div class="flex gap-2 flex-shrink-0">
                                    <button class="accept-btn bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600" data-appt-id="${appt.id}" data-patient-uid="${appt.patientId}">Accept</button>
                                    <button class="decline-btn bg-red-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-600" data-appt-id="${appt.id}" data-patient-uid="${appt.patientId}">Decline</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        pendingApptsList.innerHTML = `<p class="text-sm text-slate-500">No new requests.</p>`;
                    }

                    if (acceptedAppts.length > 0) {
                        acceptedApptsList.innerHTML = acceptedAppts.map(appt => `
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200 flex items-center justify-between gap-4">
                                <div>
                                    <div class="font-semibold text-slate-800">Appointment with ${appt.patientName}</div>
                                    <div class="text-sm text-slate-600">On ${appt.date} at ${appt.time}</div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        acceptedApptsList.innerHTML = `<p class="text-sm text-slate-500">No upcoming appointments.</p>`;
                    }
                });
            };
            
            pendingApptsList.addEventListener('click', async (e) => {
                const acceptBtn = e.target.closest('.accept-btn');
                const declineBtn = e.target.closest('.decline-btn');
                if (acceptBtn) {
                    const apptId = acceptBtn.dataset.apptId;
                    const patientUid = acceptBtn.dataset.patientUid;
                    
                    try {
                        const apptRef = doc(db, `artifacts/${appId}/public/data/appointments`, apptId);
                        await updateDoc(apptRef, { status: 'accepted' });
                        showMessage("Success", `Appointment accepted.`);
                    } catch (e) {
                        console.error("Error accepting appointment:", e);
                    }
                } else if (declineBtn) {
                    const apptId = declineBtn.dataset.apptId;
                    const patientUid = declineBtn.dataset.patientUid;
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/appointments`, apptId));
                        showMessage("Declined", `Appointment declined.`);
                    } catch (e) {
                        console.error("Error declining appointment:", e);
                    }
                }
            });

            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredPatients = doctorState.patients.filter(p => p.name.toLowerCase().includes(searchTerm) || p.patientId.toLowerCase().includes(searchTerm));
                displayPatients(filteredPatients);
            });
            patientList.addEventListener('click', (e) => {
                const card = e.target.closest('[data-patient-uid]');
                if (card) { showDoctorSection('patient-profile-view'); populatePatientProfile(card.dataset.patientUid); }
            });
            document.getElementById('patient-profile-view').addEventListener('click', (e) => {
                const previewButton = e.target.closest('.preview-btn');
                if (previewButton) { openFileModal(previewButton.dataset.file, previewButton.dataset.title); }
            });
            backToSearchBtn.addEventListener('click', () => showDoctorSection('patient-search-view'));
            tabButtons.forEach(button => button.addEventListener('click', () => switchTab(button.dataset.tab)));
            closeModalButton.addEventListener('click', closeFileModal);
            modalCloseFooter.addEventListener('click', closeFileModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeFileModal(); });
            modalDownloadBtn.addEventListener('click', () => window.open(currentFileUrl, '_blank'));
            navTabs.forEach(tab => tab.addEventListener('click', (e) => { 
                e.preventDefault(); 
                showDoctorSection(tab.dataset.target); 
            }));
            
            document.getElementById('doctor-sidebar-name').textContent = doctorState.doctorDetails.name;
            document.getElementById('doctor-sidebar-id').textContent = `ID: ${doctorState.doctorDetails.doctorId}`;

            showDoctorSection('patient-search-view');
            displayPatients(doctorState.patients);
            lucide.createIcons();
            doctorDashboardInitialized = true;
        };

        const messagesModal = document.getElementById('messages-modal');
        const messagesModalTitle = document.getElementById('messages-modal-title');
        const closeMessagesModalBtn = document.getElementById('close-messages-modal');
        const conversationsList = document.getElementById('conversations-list');
        const conversationView = document.getElementById('conversation-view');
        const selectConversationView = document.getElementById('select-conversation-view');
        const backToConversationsBtn = document.getElementById('back-to-conversations');
        const messageContainer = document.getElementById('message-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const composeMessageBtn = document.getElementById('compose-message-btn');

        let activeConversationId = null;
        let unsubscribeMessages = null;
        
        const openMessageModal = async (recipientId = null) => {
            const messagesModal = document.getElementById('messages-modal');
            const messagesModalContent = messagesModal.querySelector('div.flex.flex-col');
            toggleModal(messagesModal, messagesModalContent, true);
            if (recipientId) {
                await createOrFindConversation(recipientId);
            } else {
                showConversationList();
            }
        };

        const showConversationList = () => {
            selectConversationView.classList.remove('hidden');
            conversationView.classList.add('hidden');
            backToConversationsBtn.classList.add('hidden');
            messagesModalTitle.textContent = "Messages";
            
            conversationsList.innerHTML = `<p class="text-sm text-slate-500 text-center">Loading conversations...</p>`;
            
            const q = query(collection(db, `artifacts/${appId}/public/data/conversations`), 
                where('participants', 'array-contains', currentUser.uid));
            
            onSnapshot(q, (snapshot) => {
                const conversations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (conversations.length > 0) {
                    conversationsList.innerHTML = conversations.map(c => {
                        const otherParticipantId = c.participants.find(p => p !== currentUser.uid);
                        const otherParticipant = c.patient?.userId === otherParticipantId ? c.patient : c.doctor;
                        if (!otherParticipant) return '';

                        const avatarText = otherParticipant.name.split(' ').map(n => n[0]).join('');
                        const name = userRole === 'patient' ? 'Dr. ' + otherParticipant.name : otherParticipant.name;

                        return `<button data-conversation-id="${c.id}" class="conversation-item w-full flex items-center gap-4 p-3 rounded-lg border hover:bg-slate-50 transition-colors">
                            <div class="w-10 h-10 rounded-full bg-blue-200 text-blue-800 flex items-center justify-center font-bold">${avatarText}</div>
                            <div class="flex-grow text-left">
                                <div class="font-semibold text-slate-800">${name}</div>
                                <div class="text-sm text-slate-500 truncate">${c.lastMessageText || 'Start a conversation...'}</div>
                            </div>
                            <div class="text-xs text-slate-400">${c.lastMessageTime ? new Date(c.lastMessageTime.toDate()).toLocaleString() : ''}</div>
                        </button>`;
                    }).join('');
                } else {
                    conversationsList.innerHTML = `<p class="text-sm text-slate-500 text-center">No active conversations. Start a new one.</p>`;
                }
            });
        };

        const showConversation = async (conversationId) => {
            selectConversationView.classList.add('hidden');
            conversationView.classList.remove('hidden');
            backToConversationsBtn.classList.remove('hidden');
            activeConversationId = conversationId;
            messageContainer.innerHTML = `<p class="text-center text-slate-400">Loading messages...</p>`;

            if (unsubscribeMessages) {
                unsubscribeMessages();
            }

            const convoRef = doc(db, `artifacts/${appId}/public/data/conversations`, conversationId);
            const convoSnap = await getDoc(convoRef);
            const convoData = convoSnap.data();
            
            const otherParticipantId = convoData.participants.find(p => p !== currentUser.uid);
            const otherParticipant = convoData.patient?.userId === otherParticipantId ? convoData.patient : convoData.doctor;
            messagesModalTitle.textContent = otherParticipant.name;

            const messagesQuery = query(collection(db, `artifacts/${appId}/public/data/conversations/${conversationId}/messages`), orderBy('timestamp'));
            
            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                messageContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const isSender = msg.senderId === currentUser.uid;
                    const messageClass = isSender ? 'self-end bg-blue-500 text-white rounded-tr-none' : 'self-start bg-slate-200 text-slate-800 rounded-tl-none';
                    const messageHtml = `<div class="flex flex-col max-w-[80%] p-3 rounded-xl shadow-sm ${messageClass}">
                        <p class="text-sm">${msg.text}</p>
                        <span class="text-xs opacity-75 mt-1">${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString() : 'Just now'}</span>
                    </div>`;
                    messageContainer.innerHTML += messageHtml;
                });
                messageContainer.scrollTop = messageContainer.scrollHeight;
            });
        };

        const sendMessage = async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text === '') return;
            
            const messagesRef = collection(db, `artifacts/${appId}/public/data/conversations/${activeConversationId}/messages`);
            const convoRef = doc(db, `artifacts/${appId}/public/data/conversations`, activeConversationId);

            try {
                await addDoc(messagesRef, {
                    senderId: currentUser.uid,
                    text: text,
                    timestamp: serverTimestamp()
                });

                await updateDoc(convoRef, {
                    lastMessageText: text,
                    lastMessageTime: serverTimestamp()
                });

                messageInput.value = '';
            } catch (e) {
                console.error("Error sending message:", e);
            }
        };

        const createOrFindConversation = async (recipientId) => {
            const q = query(collection(db, `artifacts/${appId}/public/data/conversations`), 
                where('participants', 'array-contains', currentUser.uid));
            const existingConversations = await getDocs(q);

            let conversationId;
            let existingDoc = null;
            
            existingConversations.forEach(doc => {
                const data = doc.data();
                if (data.participants.includes(recipientId)) {
                    existingDoc = doc;
                }
            });

            if (existingDoc) {
                conversationId = existingDoc.id;
            } else {
                const newConvoRef = doc(collection(db, `artifacts/${appId}/public/data/conversations`));
                const patientId = userRole === 'patient' ? currentUser.uid : recipientId;
                const doctorId = userRole === 'doctor' ? currentUser.uid : recipientId;
                
                const patientData = userRole === 'patient' ? patientState.patientDetails : (await getDoc(doc(db, `artifacts/${appId}/users/${patientId}`))).data()?.details;
                const doctorData = userRole === 'doctor' ? doctorState.doctorDetails : (await getDoc(doc(db, `artifacts/${appId}/users/${doctorId}`))).data()?.details;

                const newConvoData = {
                    participants: [patientId, doctorId],
                    patient: { userId: patientId, name: patientData.name },
                    doctor: { userId: doctorId, name: doctorData.name },
                    createdAt: serverTimestamp(),
                    lastMessageTime: serverTimestamp(),
                    lastMessageText: ""
                };
                
                await setDoc(newConvoRef, newConvoData);
                conversationId = newConvoRef.id;
            }

            showConversation(conversationId);
        };

        closeMessagesModalBtn.addEventListener('click', () => {
            const messagesModal = document.getElementById('messages-modal');
            const messagesModalContent = messagesModal.querySelector('div.flex.flex-col');
            toggleModal(messagesModal, messagesModalContent, false);
            if (unsubscribeMessages) {
                unsubscribeMessages();
                unsubscribeMessages = null;
            }
        });
        backToConversationsBtn.addEventListener('click', showConversationList);
        messageForm.addEventListener('submit', sendMessage);
        conversationsList.addEventListener('click', (e) => {
            const convoBtn = e.target.closest('.conversation-item');
            if (convoBtn) {
                const convoId = convoBtn.dataset.conversationId;
                showConversation(convoId);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            showLoading(true);
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    await fetchAndSetUserData(user.uid);
                } else {
                    currentUser = null;
                    showView('landing');
                    showLoading(false);
                }
            });

            const seedDemoData = async () => {
                const usersRef = collection(db, `artifacts/${appId}/users`);
                const userCount = (await getDocs(usersRef)).size;

                if (userCount === 0) {
                    const demoPatient = {
                        role: 'patient',
                        details: {
                            name: 'Jane Doe',
                            email: 'patient@example.com',
                            dob: '1985-05-22',
                            gender: 'Female',
                            contact: '+1 (555) 123-4567',
                            emergencyContact: 'John Doe, +1 (555) 987-6543',
                            bloodGroup: 'O+',
                            allergies: 'Penicillin, Peanuts',
                            medications: 'N/A',
                            history: 'Asthma (Mild)',
                            consent_doctors: true,
                            consent_research: false,
                            patientId: 'PID73921'
                        }
                    };
                    const demoDoctor = {
                        role: 'doctor',
                        details: {
                            name: 'Dr. Alex Turner',
                            email: 'doctor@example.com',
                            specialization: 'Cardiology',
                            experience: '15',
                            license: 'MD12345678',
                            hospital: 'Central Hospital',
                            contactEmail: 'alex.turner.md@mediconnect.com',
                            doctorId: 'DOC002'
                        }
                    };
                    try {
                        await createUserWithEmailAndPassword(auth, demoPatient.details.email, "password123");
                        await setDoc(doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}`), demoPatient);
                        await signOut(auth);

                        await createUserWithEmailAndPassword(auth, demoDoctor.details.email, "password123");
                        await setDoc(doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}`), demoDoctor);
                        await signOut(auth);
                        console.log("Demo data seeded successfully.");
                    } catch (e) {
                        console.error("Error seeding demo data:", e);
                    }
                }
            };
            seedDemoData();

            initLandingPage();
            lucide.createIcons();
            showView('landing');
        });

        window.alert = function(message) {
            showMessage("Notification", message);
        };
    </script>
</body>
</html>
